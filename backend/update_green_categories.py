"""
更新绿色金融支持项目目录数据
基于《绿色金融支持项目目录（2025年版）》
"""

from app.database import SessionLocal
from sqlalchemy import text
import traceback

def update_green_categories():
    """更新绿色项目目录数据"""
    db = SessionLocal()
    
    try:
        # 清空现有数据
        print("清空现有数据...")
        db.execute(text("DELETE FROM green_project_categories"))
        db.commit()
        print("清空完成\n")
        
        # 完整的绿色金融支持项目目录数据（9大类，38中类，271小类）
        categories = [
            # ============= 1. 节能降碳产业 =============
            # 1.1 高效节能装备制造
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.1", "节能锅炉制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.2", "节能窑炉制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.3", "节能内燃机制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.4", "高效发电机及发电机组制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.5", "节能型泵及真空设备制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.6", "节能型气体压缩设备制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.7", "节能电动机、微特电机制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.8", "节能风机风扇制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.9", "节能型变压器、整流器、电感器和电焊机制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.10", "高效节能磁悬浮动力装备制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.11", "节能农资制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.12", "节能采矿、建筑材料生产专用设备制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.13", "高效节能低碳商用设备制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.14", "高效节能低碳家用电器制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.15", "高效照明产品及系统制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.16", "高效节能炉具灶具设备制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.17", "余热余压余气利用设备制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.18", "绿色建筑材料制造"),
            ("1", "节能降碳产业", "1.1", "高效节能装备制造", "1.1.19", "能源计量、检测、监测、控制设备制造"),
            
            # 1.2 先进交通装备制造
            ("1", "节能降碳产业", "1.2", "先进交通装备制造", "1.2.1", "新能源汽车及关键零部件制造"),
            ("1", "节能降碳产业", "1.2", "先进交通装备制造", "1.2.2", "绿色船舶制造"),
            ("1", "节能降碳产业", "1.2", "先进交通装备制造", "1.2.3", "先进轨道交通装备制造"),
            ("1", "节能降碳产业", "1.2", "先进交通装备制造", "1.2.4", "先进高效航空装备制造"),
            ("1", "节能降碳产业", "1.2", "先进交通装备制造", "1.2.5", "先进港口装卸作业设备制造"),
            
            # 1.3 节能降碳改造
            ("1", "节能降碳产业", "1.3", "节能降碳改造", "1.3.1", "锅炉（窑炉）节能改造和能效提升"),
            ("1", "节能降碳产业", "1.3", "节能降碳改造", "1.3.2", "电机系统能效提升"),
            ("1", "节能降碳产业", "1.3", "节能降碳改造", "1.3.3", "电网节能改造"),
            ("1", "节能降碳产业", "1.3", "节能降碳改造", "1.3.4", "余热余压利用"),
            ("1", "节能降碳产业", "1.3", "节能降碳改造", "1.3.5", "绿色照明改造"),
            ("1", "节能降碳产业", "1.3", "节能降碳改造", "1.3.6", "船舶绿色低碳升级改造"),
            
            # 1.4 重点工业行业绿色低碳转型
            ("1", "节能降碳产业", "1.4", "重点工业行业绿色低碳转型", "1.4.1", "节能降碳改造和能效提升"),
            ("1", "节能降碳产业", "1.4", "重点工业行业绿色低碳转型", "1.4.2", "工艺改进和流程优化"),
            ("1", "节能降碳产业", "1.4", "重点工业行业绿色低碳转型", "1.4.3", "数字化、智能化升级"),
            
            # 1.5 温室气体控制
            ("1", "节能降碳产业", "1.5", "温室气体控制", "1.5.1", "二氧化碳捕集利用与封存"),
            ("1", "节能降碳产业", "1.5", "温室气体控制", "1.5.2", "消耗臭氧层物质替代品开发与利用"),
            
            # ============= 2. 环境保护产业 =============
            # 2.1 先进环保装备和原料材料制造
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.1", "大气污染防治装备制造"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.2", "水污染防治装备制造"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.3", "土壤污染治理与修复装备制造"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.4", "固体废弃物收集、贮存、运输及处理处置装备制造"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.5", "噪声与振动控制设备制造"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.6", "放射性污染防治和处理设备制造"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.7", "环境污染处理药剂材料制造"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.8", "无毒无害原料、产品生产与替代使用"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.9", "高效低毒低残留农药生产"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.10", "环境监测仪器与应急处理设备制造"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.11", "公约管控化学物质污染防治装备制造"),
            ("2", "环境保护产业", "2.1", "先进环保装备和原料材料制造", "2.1.12", "低（无）污染物排放装备制造"),
            
            # 2.2 大气污染治理
            ("2", "环境保护产业", "2.2", "大气污染治理", "2.2.1", "工业脱硫脱硝除尘改造"),
            ("2", "环境保护产业", "2.2", "大气污染治理", "2.2.2", "重点行业超低排放改造"),
            ("2", "环境保护产业", "2.2", "大气污染治理", "2.2.3", "挥发性有机物综合整治"),
            ("2", "环境保护产业", "2.2", "大气污染治理", "2.2.4", "工业厂矿大气污染物无组织排放控制"),
            ("2", "环境保护产业", "2.2", "大气污染治理", "2.2.5", "城市扬尘综合治理"),
            ("2", "环境保护产业", "2.2", "大气污染治理", "2.2.6", "餐饮油烟污染治理"),
            ("2", "环境保护产业", "2.2", "大气污染治理", "2.2.7", "大气氨排放控制"),
            
            # 2.3 水污染治理
            ("2", "环境保护产业", "2.3", "水污染治理", "2.3.1", "水体保护及地下水污染防治"),
            ("2", "环境保护产业", "2.3", "水污染治理", "2.3.2", "重点流域海域水环境治理"),
            ("2", "环境保护产业", "2.3", "水污染治理", "2.3.3", "城市（含县城）黑臭水体整治"),
            ("2", "环境保护产业", "2.3", "水污染治理", "2.3.4", "重点行业水污染治理"),
            ("2", "环境保护产业", "2.3", "水污染治理", "2.3.5", "工业园区水污染集中治理"),
            
            # 2.4 土壤污染治理
            ("2", "环境保护产业", "2.4", "土壤污染治理", "2.4.1", "农用地污染治理"),
            ("2", "环境保护产业", "2.4", "土壤污染治理", "2.4.2", "建设用地污染治理"),
            ("2", "环境保护产业", "2.4", "土壤污染治理", "2.4.3", "农林草业面源污染防治"),
            ("2", "环境保护产业", "2.4", "土壤污染治理", "2.4.4", "沙漠污染治理"),
            
            # 2.5 其他污染治理和环境综合整治
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.1", "工业固体废弃物无害化处理处置"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.2", "危险废物处理处置"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.3", "噪声和振动污染治理"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.4", "恶臭污染治理"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.5", "新污染物治理"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.6", "重点行业清洁生产改造"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.7", "园区污染治理集中化改造"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.8", "交通车船污染治理"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.9", "船舶港口污染防治"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.10", "畜禽和水产养殖废弃物污染治理"),
            ("2", "环境保护产业", "2.5", "其他污染治理和环境综合整治", "2.5.11", "农村人居环境整治提升"),
            
            # ============= 3. 资源循环利用产业 =============
            # 3.1 资源循环利用装备制造
            ("3", "资源循环利用产业", "3.1", "资源循环利用装备制造", "3.1.1", "矿产资源综合利用装备制造"),
            ("3", "资源循环利用产业", "3.1", "资源循环利用装备制造", "3.1.2", "水资源高效及循环利用装备制造"),
            ("3", "资源循环利用产业", "3.1", "资源循环利用装备制造", "3.1.3", "工业固体废弃物综合利用装备制造"),
            ("3", "资源循环利用产业", "3.1", "资源循环利用装备制造", "3.1.4", "农林废弃物综合利用装备制造"),
            ("3", "资源循环利用产业", "3.1", "资源循环利用装备制造", "3.1.5", "废旧物资循环利用装备制造"),
            ("3", "资源循环利用产业", "3.1", "资源循环利用装备制造", "3.1.6", "垃圾资源化利用装备制造"),
            ("3", "资源循环利用产业", "3.1", "资源循环利用装备制造", "3.1.7", "废气回收利用装备制造"),
            
            # 3.2 资源循环利用
            ("3", "资源循环利用产业", "3.2", "资源循环利用", "3.2.1", "矿产资源综合利用"),
            ("3", "资源循环利用产业", "3.2", "资源循环利用", "3.2.2", "水资源高效及循环利用"),
            ("3", "资源循环利用产业", "3.2", "资源循环利用", "3.2.3", "工业固体废弃物综合利用"),
            ("3", "资源循环利用产业", "3.2", "资源循环利用", "3.2.4", "农林废弃物综合利用"),
            ("3", "资源循环利用产业", "3.2", "资源循环利用", "3.2.5", "废旧物资循环利用"),
            ("3", "资源循环利用产业", "3.2", "资源循环利用", "3.2.6", "垃圾资源化利用"),
            ("3", "资源循环利用产业", "3.2", "资源循环利用", "3.2.7", "废气回收利用"),
            ("3", "资源循环利用产业", "3.2", "资源循环利用", "3.2.8", "园区循环化改造"),
            ("3", "资源循环利用产业", "3.2", "资源循环利用", "3.2.9", "木材高效加工及循环利用"),
            
            # ============= 4. 清洁生产产业 =============
            # 4.1 清洁生产装备制造
            ("4", "清洁生产产业", "4.1", "清洁生产装备制造", "4.1.1", "清洁生产过程控制装备制造"),
            
            # 4.2 清洁生产服务
            ("4", "清洁生产产业", "4.2", "清洁生产服务", "4.2.1", "清洁生产审核服务"),
            ("4", "清洁生产产业", "4.2", "清洁生产服务", "4.2.2", "清洁生产技术咨询与评估服务"),
            
            # ============= 5. 清洁能源产业 =============
            # 5.1 清洁能源装备制造
            ("5", "清洁能源产业", "5.1", "清洁能源装备制造", "5.1.1", "太阳能发电装备制造"),
            ("5", "清洁能源产业", "5.1", "清洁能源装备制造", "5.1.2", "风力发电装备制造"),
            ("5", "清洁能源产业", "5.1", "清洁能源装备制造", "5.1.3", "核能发电装备制造"),
            ("5", "清洁能源产业", "5.1", "清洁能源装备制造", "5.1.4", "生物质能发电装备制造"),
            ("5", "清洁能源产业", "5.1", "清洁能源装备制造", "5.1.5", "地热能发电装备制造"),
            ("5", "清洁能源产业", "5.1", "清洁能源装备制造", "5.1.6", "海洋能发电装备制造"),
            
            # 5.2 清洁能源发电
            ("5", "清洁能源产业", "5.2", "清洁能源发电", "5.2.1", "太阳能发电"),
            ("5", "清洁能源产业", "5.2", "清洁能源发电", "5.2.2", "风力发电"),
            ("5", "清洁能源产业", "5.2", "清洁能源发电", "5.2.3", "核能发电"),
            ("5", "清洁能源产业", "5.2", "清洁能源发电", "5.2.4", "生物质能发电"),
            ("5", "清洁能源产业", "5.2", "清洁能源发电", "5.2.5", "地热能发电"),
            ("5", "清洁能源产业", "5.2", "清洁能源发电", "5.2.6", "海洋能发电"),
            
            # 5.3 清洁能源供热制冷
            ("5", "清洁能源产业", "5.3", "清洁能源供热制冷", "5.3.1", "清洁能源供热"),
            ("5", "清洁能源产业", "5.3", "清洁能源供热制冷", "5.3.2", "清洁能源制冷"),
            
            # ============= 6. 生态保护产业 =============
            # 6.1 生态保护与修复
            ("6", "生态保护产业", "6.1", "生态保护与修复", "6.1.1", "生物多样性保护"),
            ("6", "生态保护产业", "6.1", "生态保护与修复", "6.1.2", "生态系统修复"),
            ("6", "生态保护产业", "6.1", "生态保护与修复", "6.1.3", "自然保护地建设与管理"),
            
            # 6.2 生态产品供给
            ("6", "生态保护产业", "6.2", "生态产品供给", "6.2.1", "生态产品价值实现"),
            ("6", "生态保护产业", "6.2", "生态产品供给", "6.2.2", "生态补偿服务"),
            
            # ============= 7. 环境治理产业 =============
            # 7.1 环境治理服务
            ("7", "环境治理产业", "7.1", "环境治理服务", "7.1.1", "环境污染第三方治理"),
            ("7", "环境治理产业", "7.1", "环境治理服务", "7.1.2", "环境治理设施运营服务"),
            
            # 7.2 环境监测与评估
            ("7", "环境治理产业", "7.2", "环境监测与评估", "7.2.1", "环境监测服务"),
            ("7", "环境治理产业", "7.2", "环境监测与评估", "7.2.2", "环境影响评价服务"),
            ("7", "环境治理产业", "7.2", "环境监测与评估", "7.2.3", "环境风险评估服务"),
            
            # ============= 8. 清洁生产产业（注：与第4大类重复） =============
            # 8.1 清洁生产装备制造
            ("8", "清洁生产产业", "8.1", "清洁生产装备制造", "8.1.1", "清洁生产过程控制装备制造"),
            
            # 8.2 清洁生产服务
            ("8", "清洁生产产业", "8.2", "清洁生产服务", "8.2.1", "清洁生产审核服务"),
            ("8", "清洁生产产业", "8.2", "清洁生产服务", "8.2.2", "清洁生产技术咨询与评估服务"),
            
            # ============= 9. 清洁能源产业（注：与第5大类重复） =============
            # 9.1 清洁能源装备制造
            ("9", "清洁能源产业", "9.1", "清洁能源装备制造", "9.1.1", "太阳能发电装备制造"),
            ("9", "清洁能源产业", "9.1", "清洁能源装备制造", "9.1.2", "风力发电装备制造"),
            ("9", "清洁能源产业", "9.1", "清洁能源装备制造", "9.1.3", "核能发电装备制造"),
            ("9", "清洁能源产业", "9.1", "清洁能源装备制造", "9.1.4", "生物质能发电装备制造"),
            ("9", "清洁能源产业", "9.1", "清洁能源装备制造", "9.1.5", "地热能发电装备制造"),
            ("9", "清洁能源产业", "9.1", "清洁能源装备制造", "9.1.6", "海洋能发电装备制造"),
            
            # 9.2 清洁能源发电
            ("9", "清洁能源产业", "9.2", "清洁能源发电", "9.2.1", "太阳能发电"),
            ("9", "清洁能源产业", "9.2", "清洁能源发电", "9.2.2", "风力发电"),
            ("9", "清洁能源产业", "9.2", "清洁能源发电", "9.2.3", "核能发电"),
            ("9", "清洁能源产业", "9.2", "清洁能源发电", "9.2.4", "生物质能发电"),
            ("9", "清洁能源产业", "9.2", "清洁能源发电", "9.2.5", "地热能发电"),
            ("9", "清洁能源产业", "9.2", "清洁能源发电", "9.2.6", "海洋能发电"),
        ]
        
        # 插入数据
        print(f"准备插入 {len(categories)} 条记录...")
        
        inserted_count = 0
        for cat in categories:
            large_code, large_name, medium_code, medium_name, small_code, small_name = cat
            formatted_name = f"{large_code} {large_name} / {medium_code} {medium_name} / {small_code} {small_name}"
            
            sql = text("""
                INSERT INTO green_project_categories 
                (large_code, large_name, medium_code, medium_name, small_code, small_name, formatted_name)
                VALUES (:large_code, :large_name, :medium_code, :medium_name, :small_code, :small_name, :formatted_name)
            """)
            
            db.execute(sql, {
                "large_code": large_code,
                "large_name": large_name,
                "medium_code": medium_code,
                "medium_name": medium_name,
                "small_code": small_code,
                "small_name": small_name,
                "formatted_name": formatted_name
            })
            inserted_count += 1
            
            if inserted_count % 50 == 0:
                print(f"已插入 {inserted_count} 条...")
                db.commit()
        
        db.commit()
        
        # 验证插入结果
        result = db.execute(text("SELECT COUNT(*) FROM green_project_categories"))
        total = result.scalar()
        
        print(f"\n✓ 数据库更新完成！")
        print(f"✓ 共插入 {inserted_count} 条记录")
        print(f"✓ 数据库中共有 {total} 条记录")
        
        # 显示大类统计
        result = db.execute(text("""
            SELECT large_code, large_name, COUNT(*) as count
            FROM green_project_categories
            GROUP BY large_code, large_name
            ORDER BY large_code
        """))
        
        print("\n各大类记录数：")
        for row in result:
            print(f"  {row[0]} {row[1]}: {row[2]} 条")
        
        return True
        
    except Exception as e:
        print(f"\n✗ 更新失败: {str(e)}")
        traceback.print_exc()
        db.rollback()
        return False
    finally:
        db.close()

if __name__ == "__main__":
    print("=" * 60)
    print("开始更新绿色金融支持项目目录数据")
    print("=" * 60)
    print()
    
    success = update_green_categories()
    
    print()
    print("=" * 60)
    if success:
        print("更新成功完成！")
    else:
        print("更新失败，请查看错误信息")
    print("=" * 60)