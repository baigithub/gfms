import{_ as ie,s as re,q as ce,o as d,c as v,b as e,w as s,r as u,p as k,n as de,d as ue,v as _e,$ as pe,a1 as fe,i as C,a as o,t as r,m as c,e as g,a3 as me,a6 as ge,Y as he,F as O,y as G,g as K,a7 as ve,O as ye,j as T,z as be,D as ke,a8 as we,a9 as ze,a2 as q,E as x,L as Ce,u as Te}from"./index-D4Rku7DI.js";import{F as xe}from"./FlowChart-CWbDuyhS.js";import{h as De,b as J,a as Me,c as je,w as Be}from"./green_finance-C_pmG5wr.js";import"./index-VufPjWZz.js";import"./index-D5GkNzM3.js";const Ve={class:"task-page"},Se={class:"card-header"},Ue={class:"header-left"},Ee={class:"header-icon"},$e={class:"index-badge"},Fe={class:"customer-name"},Ye={class:"loan-account"},Le={class:"amount-value"},Pe={class:"date-value"},Ie={class:"project-category-wrap"},Ne={class:"action-buttons"},Re={class:"pagination-container"},We={class:"timeline-container"},Ae={class:"timeline-content"},He={class:"timeline-header"},Oe={class:"timeline-title"},Ge={class:"timeline-detail"},Ke={class:"detail-item"},qe={class:"detail-item"},Je={key:0,class:"timeline-result"},Qe={key:1,class:"timeline-comment"},Xe={key:2,class:"timeline-reason"},Ze={class:"attachments-container"},et={class:"category-trace-container"},tt={class:"category-trace"},at={class:"trace-header"},st={class:"trace-title"},lt={class:"trace-detail"},ot={class:"detail-item"},nt={key:0,class:"detail-item"},it={key:0,class:"trace-category"},rt={class:"category-label"},ct={class:"category-value"},dt={key:1,class:"trace-category-empty"},ut={class:"dialog-footer"},_t={__name:"TaskCompleted",setup(pt){ue();const Q=_e(),D=k(!1),Y=k([]),y=de({page:1,page_size:10,total:0}),B=k(!1),S=k("business"),_=k({}),b=k([]),U=k(null),L=l=>l?Number(l).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",P=l=>l?q(l).format("YYYY-MM-DD"):"-",I=l=>l?q(l).format("YYYY-MM-DD HH:mm:ss"):"-",N=l=>{if(l.formatted_category)return l.formatted_category;const a=[];return l.project_category_large&&a.push(l.project_category_large),l.project_category_medium&&a.push(l.project_category_medium),l.project_category_small&&a.push(l.project_category_small),a.join("/")||"-"},X=l=>{if(!l)return"0 B";const a=1024,i=["B","KB","MB","GB"],n=Math.floor(Math.log(l)/Math.log(a));return Math.round(l/Math.pow(a,n)*100)/100+" "+i[n]},Z=async l=>{try{const i=Te().token;if(!i){x.error("未登录,请先登录");return}const w=`http://localhost:8000${l.download_url}`,z=await fetch(w,{headers:{Authorization:`Bearer ${i}`}});if(!z.ok)throw new Error(`下载失败: ${z.status}`);const m=await z.blob(),h=window.URL.createObjectURL(m),f=document.createElement("a");f.href=h,f.download=l.original_filename,f.style.display="none",f.target="_blank",f.rel="noopener noreferrer",document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(h),x.success("下载成功")}catch(a){console.error("下载失败:",a),x.error("下载失败")}},R=l=>l==="已完成"?"success":l==="待处理"?"primary":l==="已撤回"?"info":"warning",W=l=>({待办:"warning",已办:"primary",办结:"success",驳回:"danger",撤回:"info"})[l]||"info",M=async()=>{D.value=!0;try{const l=await De({page:y.page,page_size:y.page_size});Y.value=l.items,y.total=l.total,E.value.clear();for(const a of l.items)try{const i=a.identification_id||a.id,n=await J(i);E.value.set(i,n)}catch(i){console.error(`获取任务 ${a.identification_id} 的工作流历史失败:`,i)}}catch(l){console.error("Failed to load tasks:",l)}finally{D.value=!1}},E=k(new Map),ee=l=>{if(l.status!=="办理中")return!1;const a=l.identification_id||l.id,i=E.value.get(a);if(!i||i.length===0)return!1;const n=i.filter(p=>p.status==="已完成");if(n.length===0)return!1;const z=n[n.length-1].task_key,m=["manager_identification","branch_review","first_approval","final_review"],h=m.indexOf(z);if(h===-1||h>=m.length-1)return!1;const f=m[h+1];return i.filter(p=>p.task_key===f&&p.status==="待处理").length>0},te=async l=>{var a,i;try{await Ce.confirm("确定要撤回此任务吗？撤回后任务将出现在您的待办任务列表中。","撤回确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),D.value=!0,await Be(l.task_id||l.id),x.success("任务已撤回到待办任务列表"),await M()}catch(n){n!=="cancel"&&(console.error("撤回任务失败:",n),x.error(((i=(a=n.response)==null?void 0:a.data)==null?void 0:i.detail)||"撤回任务失败"))}finally{D.value=!1}},ae=async l=>{try{console.log("handleView called with row:",l),console.log("row.task_id:",l.task_id),console.log("row.identification_id:",l.identification_id);const[a,i]=await Promise.all([Me(l.task_id),J(l.identification_id)]);console.log("detail:",a),console.log("detail.attachments:",a.attachments),console.log("detail.attachments type:",typeof a.attachments),console.log("detail.attachments length:",a.attachments?a.attachments.length:0),console.log("history:",i),_.value=a,b.value=i;try{const n=await je(l.identification_id);U.value=(n==null?void 0:n.process_definition_id)||null}catch(n){console.warn("获取工作流实例失败:",n),U.value=null}console.log("currentTask.value after assignment:",_.value),console.log("currentTask.value.attachments after assignment:",_.value.attachments),B.value=!0,S.value="business"}catch(a){console.error("获取任务详情失败:",a),x.error("获取任务详情失败")}};return re(()=>{M()}),ce(()=>Q.query.t,()=>{M()}),(l,a)=>{const i=u("el-icon"),n=u("el-table-column"),w=u("el-tag"),z=u("ElementPlus"),m=u("el-button"),h=u("el-table"),f=u("el-pagination"),V=u("el-card"),p=u("el-descriptions-item"),se=u("el-descriptions"),j=u("el-tab-pane"),A=u("el-timeline-item"),H=u("el-timeline"),$=u("el-empty"),le=u("el-tabs"),oe=u("el-dialog"),ne=pe("loading");return d(),v("div",Ve,[e(V,{shadow:"hover",class:"main-card"},{header:s(()=>[o("div",Se,[o("div",Ue,[o("div",Ee,[e(i,{size:"24"},{default:s(()=>[e(g(he))]),_:1})]),a[5]||(a[5]=o("div",{class:"header-content"},[o("span",{class:"card-title"},"已办任务"),o("span",{class:"card-subtitle"},"查看所有已完成的任务")],-1))])])]),default:s(()=>[fe((d(),C(h,{data:Y.value,stripe:"","show-header":"",class:"modern-table","header-cell-style":{background:"#f5f7fa",color:"#606266",fontWeight:"600"},"cell-style":{padding:"16px 0"}},{default:s(()=>[e(n,{type:"index",label:"序号",width:"80",align:"center"},{default:s(({$index:t})=>[o("div",$e,r(t+1),1)]),_:1}),e(n,{prop:"customer_name",label:"客户名称","min-width":"150"},{default:s(({row:t})=>[o("div",Fe,r(t.customer_name),1)]),_:1}),e(n,{prop:"business_type",label:"业务品种",width:"150"},{default:s(({row:t})=>[e(w,{type:"success",effect:"plain",size:"small"},{default:s(()=>[c(r(t.business_type),1)]),_:2},1024)]),_:1}),e(n,{prop:"loan_account",label:"贷款账号",width:"150"},{default:s(({row:t})=>[o("div",Ye,r(t.loan_account),1)]),_:1}),e(n,{prop:"loan_amount",label:"放款金额(元)",width:"140"},{default:s(({row:t})=>[o("div",Le,r(L(t.loan_amount)),1)]),_:1}),e(n,{prop:"disbursement_date",label:"放款日",width:"120"},{default:s(({row:t})=>[o("div",Pe,r(P(t.disbursement_date)),1)]),_:1}),e(n,{label:"绿色金融支持项目目录","min-width":"200"},{default:s(({row:t})=>[o("div",Ie,[e(i,{color:"#4CAF50"},{default:s(()=>[e(z)]),_:1}),o("span",null,r(N(t)),1)])]),_:1}),e(n,{prop:"status",label:"状态",width:"100"},{default:s(({row:t})=>[e(w,{type:W(t.status),size:"small",effect:"dark"},{default:s(()=>[c(r(t.status),1)]),_:2},1032,["type"])]),_:1}),e(n,{label:"操作",width:"150",fixed:"right",align:"center"},{default:s(({row:t})=>[o("div",Ne,[e(m,{type:"primary",link:"",size:"small",onClick:F=>ae(t)},{default:s(()=>[e(i,{class:"btn-icon"},{default:s(()=>[e(g(me))]),_:1}),a[6]||(a[6]=c(" 查看 ",-1))]),_:1},8,["onClick"]),e(m,{type:"warning",link:"",size:"small",onClick:F=>te(t),disabled:!ee(t)},{default:s(()=>[e(i,{class:"btn-icon"},{default:s(()=>[e(g(ge))]),_:1}),a[7]||(a[7]=c(" 撤回 ",-1))]),_:1},8,["onClick","disabled"])])]),_:1})]),_:1},8,["data"])),[[ne,D.value]]),o("div",Re,[e(f,{"current-page":y.page,"onUpdate:currentPage":a[0]||(a[0]=t=>y.page=t),"page-size":y.page_size,"onUpdate:pageSize":a[1]||(a[1]=t=>y.page_size=t),total:y.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:M,onCurrentChange:M,class:"modern-pagination"},null,8,["current-page","page-size","total"])])]),_:1}),e(oe,{modelValue:B.value,"onUpdate:modelValue":a[4]||(a[4]=t=>B.value=t),title:"任务详情",width:"900px",class:"modern-dialog","close-on-click-modal":!1},{footer:s(()=>[o("div",ut,[e(m,{onClick:a[3]||(a[3]=t=>B.value=!1),size:"large"},{default:s(()=>[...a[13]||(a[13]=[c("关闭",-1)])]),_:1})])]),default:s(()=>[e(le,{modelValue:S.value,"onUpdate:modelValue":a[2]||(a[2]=t=>S.value=t),class:"modern-tabs"},{default:s(()=>[e(j,{label:"业务信息",name:"business"},{default:s(()=>[e(se,{column:2,border:"",class:"modern-descriptions"},{default:s(()=>[e(p,{label:"贷款编号"},{default:s(()=>[c(r(_.value.loan_code),1)]),_:1}),e(p,{label:"客户名称"},{default:s(()=>[c(r(_.value.customer_name),1)]),_:1}),e(p,{label:"业务品种"},{default:s(()=>[c(r(_.value.business_type),1)]),_:1}),e(p,{label:"贷款账号"},{default:s(()=>[c(r(_.value.loan_account),1)]),_:1}),e(p,{label:"放款金额"},{default:s(()=>[c(r(L(_.value.loan_amount)),1)]),_:1}),e(p,{label:"放款日期"},{default:s(()=>[c(r(P(_.value.disbursement_date)),1)]),_:1}),e(p,{label:"绿色金融支持项目目录",span:2},{default:s(()=>[c(r(N(_.value)),1)]),_:1}),e(p,{label:"ESG风险等级"},{default:s(()=>[c(r(_.value.esg_risk_level),1)]),_:1}),e(p,{label:"ESG表现等级"},{default:s(()=>[c(r(_.value.esg_performance_level),1)]),_:1})]),_:1})]),_:1}),e(j,{label:"审批记录",name:"approval"},{default:s(()=>[o("div",We,[e(H,null,{default:s(()=>[(d(!0),v(O,null,G(b.value,t=>(d(),C(A,{key:t.id,timestamp:I(t.completed_at||t.started_at),placement:"top",type:R(t.status)},{default:s(()=>[e(V,{shadow:"hover",class:"timeline-card"},{default:s(()=>[o("div",Ae,[o("div",He,[o("span",Oe,r(t.task_name),1),e(w,{type:W(t.status),size:"small",effect:"dark"},{default:s(()=>[c(r(t.status),1)]),_:2},1032,["type"])]),o("div",Ge,[o("div",Ke,[e(i,{class:"detail-icon"},{default:s(()=>[e(g(K))]),_:1}),o("span",null,"审批人: "+r(t.assignee_name),1)]),o("div",qe,[e(i,{class:"detail-icon"},{default:s(()=>[e(g(ve))]),_:1}),o("span",null,"岗位: "+r(t.position_name),1)])]),t.approval_result?(d(),v("div",Je,[a[8]||(a[8]=o("span",{class:"result-label"},"审批结果: ",-1)),o("span",{class:ye(t.approval_result==="同意"?"result-agree":"result-disagree")},r(t.approval_result),3)])):T("",!0),t.comment?(d(),v("div",Qe,[a[9]||(a[9]=o("span",{class:"comment-label"},"意见: ",-1)),o("span",null,r(t.comment),1)])):T("",!0),t.reason?(d(),v("div",Xe,[a[10]||(a[10]=o("span",{class:"reason-label"},"原因: ",-1)),o("span",null,r(t.reason),1)])):T("",!0)])]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1}),!b.value||b.value.length===0?(d(),C($,{key:0,description:"暂无审批记录","image-size":80})):T("",!0)])]),_:1}),e(j,{label:"流程跟踪",name:"flow"},{default:s(()=>[e(xe,{"workflow-history":b.value,"process-definition-id":U.value},null,8,["workflow-history","process-definition-id"])]),_:1}),e(j,{label:"附件列表",name:"attachments"},{default:s(()=>[o("div",Ze,[_.value.attachments&&_.value.attachments.length>0?(d(),C(h,{key:0,data:_.value.attachments||[],stripe:"",size:"large",class:"modern-table"},{default:s(()=>[e(n,{prop:"task_name",label:"所属节点",width:"150"}),e(n,{prop:"uploader_name",label:"上传人",width:"120"}),e(n,{prop:"original_filename",label:"附件名称","min-width":"200"},{default:s(({row:t})=>[e(m,{type:"primary",link:"",size:"default",onClick:F=>Z(t),class:"file-link"},{default:s(()=>[e(i,{class:"file-icon"},{default:s(()=>[e(g(be))]),_:1}),c(" "+r(t.original_filename),1)]),_:2},1032,["onClick"])]),_:1}),e(n,{prop:"file_size",label:"文件大小",width:"100"},{default:s(({row:t})=>[c(r(X(t.file_size)),1)]),_:1}),e(n,{prop:"created_at",label:"上传时间",width:"160"})]),_:1},8,["data"])):(d(),C($,{key:1,description:"暂无附件","image-size":80}))])]),_:1}),e(j,{label:"绿色分类变动轨迹",name:"category-trace"},{default:s(()=>[o("div",et,[o("div",tt,[e(H,null,{default:s(()=>[(d(!0),v(O,null,G(b.value,(t,F)=>(d(),C(A,{key:t.id,timestamp:I(t.completed_at||t.started_at),placement:"top",type:R(t.status)},{default:s(()=>[e(V,{shadow:"hover",class:"trace-card"},{default:s(()=>[o("div",at,[o("span",st,r(t.task_name),1),e(w,{size:"small",effect:"dark"},{default:s(()=>[c(r(t.status),1)]),_:2},1024)]),o("div",lt,[o("div",ot,[e(i,{class:"detail-icon"},{default:s(()=>[e(g(K))]),_:1}),o("span",null,"办理人: "+r(t.assignee_name),1)]),t.assignee_username?(d(),v("div",nt,[e(i,{class:"detail-icon"},{default:s(()=>[e(g(ke))]),_:1}),o("span",null,"账号: "+r(t.assignee_username),1)])):T("",!0)]),t.formatted_category?(d(),v("div",it,[o("div",rt,[e(i,null,{default:s(()=>[e(g(we))]),_:1}),a[11]||(a[11]=o("span",null,"绿色金融支持项目目录:",-1))]),o("div",ct,r(t.formatted_category),1)])):(d(),v("div",dt,[e(i,null,{default:s(()=>[e(g(ze))]),_:1}),a[12]||(a[12]=o("span",null,"暂无分类信息",-1))]))]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1}),!b.value||b.value.length===0?(d(),C($,{key:0,description:"暂无分类变动轨迹","image-size":80})):T("",!0)])])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}},yt=ie(_t,[["__scopeId","data-v-798fffcb"]]);export{yt as default};
