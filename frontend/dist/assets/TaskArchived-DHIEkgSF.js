import{h as ce,a as pe,b as me}from"./green_finance-B4o63B-q.js";import{_ as fe,p as ge,o as m,c as v,b as e,w as o,r as i,m as y,j as Q,Q as ye,i as s,S as ve,s as A,t as n,a as d,F as q,y as I,I as be,x as N,T as L,E as he}from"./index-DDrUN6p6.js";import"./index-B2NntqTq.js";import"./index-D5GkNzM3.js";const je={class:"task-page"},we={class:"timeline-content"},Ve={class:"timeline-header"},ke={class:"timeline-title"},De={class:"timeline-detail"},xe={key:0,class:"timeline-result"},ze={key:1,class:"timeline-comment"},Ye={key:2,class:"timeline-reason"},Ce={class:"flow-chart"},Me={class:"timeline-content"},Ue={class:"timeline-header"},Te={class:"timeline-title"},$e={key:0,class:"trace-category"},Se={class:"category-value"},Fe={key:1,class:"trace-category"},Be={__name:"TaskArchived",setup(Ae){const U=y(!1),E=y([]),f=Q({page:1,page_size:10,total:0}),r=Q({customer_name:"",business_type:"",loan_account:"",initiator:"",project_category:""}),b=y([]),h=y([]),j=y([]),C=y(!1),T=y("business"),_=y({}),w=y([]),G=l=>l?Number(l).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",$=l=>l?L(l).format("YYYY-MM-DD"):"-",k=l=>l?L(l).format("YYYY-MM-DD HH:mm:ss"):"-",H=l=>({待处理:"warning",已完成:"success",已撤回:"info"})[l]||"info",O=l=>{if(l.formatted_category)return l.formatted_category;const a=[];return l.project_category_large&&a.push(l.project_category_large),l.project_category_medium&&a.push(l.project_category_medium),l.project_category_small&&a.push(l.project_category_small),a.join("/")||"-"},W=l=>{const a=[];return l.project_category_large_code&&l.project_category_large?a.push(`${l.project_category_large_code} ${l.project_category_large}`):l.project_category_large&&a.push(l.project_category_large),l.project_category_medium_code&&l.project_category_medium?a.push(`${l.project_category_medium_code} ${l.project_category_medium}`):l.project_category_medium&&a.push(l.project_category_medium),l.project_category_small_code&&l.project_category_small?a.push(`${l.project_category_small_code} ${l.project_category_small}`):l.project_category_small&&a.push(l.project_category_small),a.join("/")||"-"},J=l=>{if(!l)return"-";const a=1024,p=["B","KB","MB","GB"],c=Math.floor(Math.log(l)/Math.log(a));return(l/Math.pow(a,c)).toFixed(2)+" "+p[c]},X=()=>{if(!_.value)return 0;const l=_.value.status;if(l==="办结"||l==="已完成")return 5;if(w.value&&w.value.length>0){const a=w.value.filter(V=>V.status==="已完成");if(["manager_identification","branch_review","first_approval","final_review"].every(V=>w.value.some(M=>M.task_key===V&&M.status==="已完成")))return 5;if(a.length===3)return 3;if(a.length===2)return 2;if(a.length===1)return 1}return 0},Z=l=>{const p=`http://localhost:8000${l.download_url}`;window.open(p,"_blank")},ee=()=>{const l={page:f.page,page_size:f.page_size};return r.customer_name&&(l.customer_name=r.customer_name),r.business_type&&(l.business_type=r.business_type),r.loan_account&&(l.loan_account=r.loan_account),r.initiator&&(l.initiator=r.initiator),r.project_category&&(l.project_category=r.project_category),b.value&&b.value.length===2&&(l.disbursement_date_start=b.value[0],l.disbursement_date_end=b.value[1]),h.value&&h.value.length===2&&(l.completed_date_start=h.value[0],l.completed_date_end=h.value[1]),j.value&&j.value.length===2&&(l.deadline_start=j.value[0],l.deadline_end=j.value[1]),l},D=async()=>{U.value=!0;try{const l=ee(),a=await ce(l);E.value=a.items,f.total=a.total}catch(l){console.error("Failed to load tasks:",l)}finally{U.value=!1}},te=()=>{f.page=1,D()},ae=()=>{Object.assign(r,{customer_name:"",business_type:"",loan_account:"",initiator:"",project_category:""}),b.value=[],h.value=[],j.value=[],f.page=1,D()},le=async l=>{try{const[a,p]=await Promise.all([pe(l.task_id),me(l.identification_id)]);_.value=a,w.value=p,C.value=!0,T.value="business"}catch{he.error("获取任务详情失败")}};return ge(()=>{D()}),(l,a)=>{const p=i("el-input"),c=i("el-form-item"),V=i("el-option"),M=i("el-select"),S=i("el-date-picker"),x=i("el-button"),oe=i("el-form"),u=i("el-table-column"),F=i("el-tag"),P=i("el-table"),ne=i("el-pagination"),B=i("el-card"),g=i("el-descriptions-item"),se=i("el-descriptions"),z=i("el-tab-pane"),R=i("el-timeline-item"),K=i("el-timeline"),Y=i("el-step"),re=i("el-steps"),ie=i("el-tabs"),de=i("el-dialog"),ue=ye("loading");return m(),v("div",je,[e(B,{shadow:"hover"},{header:o(()=>[...a[13]||(a[13]=[d("div",{class:"card-header"},[d("span",{class:"card-title"},"办结任务")],-1)])]),default:o(()=>[e(oe,{model:r,inline:"",class:"query-form"},{default:o(()=>[e(c,{label:"客户名称"},{default:o(()=>[e(p,{modelValue:r.customer_name,"onUpdate:modelValue":a[0]||(a[0]=t=>r.customer_name=t),placeholder:"请输入",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(c,{label:"业务品种"},{default:o(()=>[e(M,{modelValue:r.business_type,"onUpdate:modelValue":a[1]||(a[1]=t=>r.business_type=t),placeholder:"请选择",clearable:"",style:{width:"150px"}},{default:o(()=>[e(V,{label:"一般性固定资产贷款",value:"一般性固定资产贷款"}),e(V,{label:"法人账户透支",value:"法人账户透支"})]),_:1},8,["modelValue"])]),_:1}),e(c,{label:"贷款账号"},{default:o(()=>[e(p,{modelValue:r.loan_account,"onUpdate:modelValue":a[2]||(a[2]=t=>r.loan_account=t),placeholder:"请输入",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(c,{label:"发起人"},{default:o(()=>[e(p,{modelValue:r.initiator,"onUpdate:modelValue":a[3]||(a[3]=t=>r.initiator=t),placeholder:"请输入",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(c,{label:"绿色金融支持项目目录"},{default:o(()=>[e(p,{modelValue:r.project_category,"onUpdate:modelValue":a[4]||(a[4]=t=>r.project_category=t),placeholder:"请输入",clearable:"",style:{width:"150px"}},null,8,["modelValue"])]),_:1}),e(c,{label:"放款日期"},{default:o(()=>[e(S,{modelValue:b.value,"onUpdate:modelValue":a[5]||(a[5]=t=>b.value=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),e(c,{label:"办结时间"},{default:o(()=>[e(S,{modelValue:h.value,"onUpdate:modelValue":a[6]||(a[6]=t=>h.value=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),e(c,{label:"任务办理截止日期"},{default:o(()=>[e(S,{modelValue:j.value,"onUpdate:modelValue":a[7]||(a[7]=t=>j.value=t),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",style:{width:"240px"}},null,8,["modelValue"])]),_:1}),e(c,null,{default:o(()=>[e(x,{type:"primary",onClick:te},{default:o(()=>[...a[14]||(a[14]=[s("查询",-1)])]),_:1}),e(x,{onClick:ae},{default:o(()=>[...a[15]||(a[15]=[s("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"]),ve((m(),A(P,{data:E.value,stripe:"",style:{width:"100%"}},{default:o(()=>[e(u,{type:"index",label:"序号",width:"60"}),e(u,{prop:"customer_name",label:"客户名称","min-width":"150"}),e(u,{prop:"business_type",label:"业务品种",width:"150"}),e(u,{prop:"loan_account",label:"贷款账号",width:"150"}),e(u,{prop:"loan_amount",label:"放款金额(元)",width:"120"},{default:o(({row:t})=>[s(n(G(t.loan_amount)),1)]),_:1}),e(u,{prop:"disbursement_date",label:"放款日",width:"120"},{default:o(({row:t})=>[s(n($(t.disbursement_date)),1)]),_:1}),e(u,{label:"绿色金融支持项目目录","min-width":"250"},{default:o(({row:t})=>[s(n(O(t)),1)]),_:1}),e(u,{prop:"deadline",label:"任务办理截止日期",width:"150"},{default:o(({row:t})=>[s(n(t.deadline?$(t.deadline):"-"),1)]),_:1}),e(u,{prop:"status",label:"状态",width:"100"},{default:o(({row:t})=>[e(F,{type:"success",size:"small"},{default:o(()=>[s(n(t.status),1)]),_:2},1024)]),_:1}),e(u,{prop:"initiator_name",label:"发起人",width:"100"}),e(u,{prop:"completed_at",label:"办结时间",width:"160"},{default:o(({row:t})=>[s(n(k(t.completed_at)),1)]),_:1}),e(u,{label:"操作",width:"120",fixed:"right"},{default:o(({row:t})=>[e(x,{type:"primary",link:"",size:"small",onClick:_e=>le(t)},{default:o(()=>[...a[16]||(a[16]=[s(" 查看 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ue,U.value]]),e(ne,{"current-page":f.page,"onUpdate:currentPage":a[8]||(a[8]=t=>f.page=t),"page-size":f.page_size,"onUpdate:pageSize":a[9]||(a[9]=t=>f.page_size=t),total:f.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:D,onCurrentChange:D,style:{"margin-top":"20px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"])]),_:1}),e(de,{modelValue:C.value,"onUpdate:modelValue":a[12]||(a[12]=t=>C.value=t),title:"任务详情",width:"900px"},{footer:o(()=>[e(x,{onClick:a[11]||(a[11]=t=>C.value=!1)},{default:o(()=>[...a[20]||(a[20]=[s("关闭",-1)])]),_:1})]),default:o(()=>[e(ie,{modelValue:T.value,"onUpdate:modelValue":a[10]||(a[10]=t=>T.value=t)},{default:o(()=>[e(z,{label:"业务信息",name:"business"},{default:o(()=>[e(se,{column:2,border:""},{default:o(()=>[e(g,{label:"贷款编号"},{default:o(()=>[s(n(_.value.loan_code),1)]),_:1}),e(g,{label:"客户名称"},{default:o(()=>[s(n(_.value.customer_name),1)]),_:1}),e(g,{label:"业务品种"},{default:o(()=>[s(n(_.value.business_type),1)]),_:1}),e(g,{label:"贷款账号"},{default:o(()=>[s(n(_.value.loan_account),1)]),_:1}),e(g,{label:"放款金额"},{default:o(()=>[s(n(G(_.value.loan_amount)),1)]),_:1}),e(g,{label:"放款日期"},{default:o(()=>[s(n($(_.value.disbursement_date)),1)]),_:1}),e(g,{label:"绿色金融支持项目目录",span:2},{default:o(()=>[s(n(_.value.formatted_category||W(_.value)),1)]),_:1}),e(g,{label:"ESG风险等级"},{default:o(()=>[s(n(_.value.esg_risk_level),1)]),_:1}),e(g,{label:"ESG表现等级"},{default:o(()=>[s(n(_.value.esg_performance_level),1)]),_:1}),e(g,{label:"办结时间",span:2},{default:o(()=>[s(n(k(_.value.completed_at)),1)]),_:1})]),_:1})]),_:1}),e(z,{label:"审批记录",name:"approval"},{default:o(()=>[e(K,null,{default:o(()=>[(m(!0),v(q,null,I(w.value,t=>(m(),A(R,{key:t.id,timestamp:k(t.completed_at||t.started_at),placement:"top"},{default:o(()=>[e(B,null,{default:o(()=>[d("div",we,[d("div",Ve,[d("span",ke,n(t.task_name),1),e(F,{type:H(t.status),size:"small"},{default:o(()=>[s(n(t.status),1)]),_:2},1032,["type"])]),d("div",De,[d("span",null,"审批人: "+n(t.assignee_name),1),d("span",null,"岗位: "+n(t.position_name),1)]),t.approval_result?(m(),v("div",xe,[a[17]||(a[17]=d("span",null,"审批结果: ",-1)),d("span",{class:be(t.approval_result==="同意"?"result-agree":"result-disagree")},n(t.approval_result),3)])):N("",!0),t.comment?(m(),v("div",ze,[d("span",null,"意见: "+n(t.comment),1)])):N("",!0),t.reason?(m(),v("div",Ye,[d("span",null,"原因: "+n(t.reason),1)])):N("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1}),e(z,{label:"流程跟踪",name:"flow"},{default:o(()=>[d("div",Ce,[e(re,{active:X(),"align-center":"","finish-status":"success"},{default:o(()=>[e(Y,{title:"开始",description:"客户经理发起认定"}),e(Y,{title:"客户经理认定",description:"填写认定信息"}),e(Y,{title:"分行审核",description:"绿色金融管理部门审核"}),e(Y,{title:"最终审批",description:"一级分行最终审批"}),e(Y,{title:"结束",description:"流程完成"})]),_:1},8,["active"])])]),_:1}),e(z,{label:"附件列表",name:"attachments"},{default:o(()=>[e(P,{data:_.value.attachments||[],stripe:"",size:"small"},{default:o(()=>[e(u,{prop:"task_name",label:"所属节点",width:"150"}),e(u,{prop:"uploader_name",label:"上传人",width:"120"}),e(u,{prop:"original_filename",label:"附件名称"},{default:o(({row:t})=>[e(x,{type:"primary",link:"",onClick:_e=>Z(t)},{default:o(()=>[s(n(t.original_filename),1)]),_:2},1032,["onClick"])]),_:1}),e(u,{prop:"file_size",label:"文件大小",width:"100"},{default:o(({row:t})=>[s(n(J(t.file_size)),1)]),_:1}),e(u,{prop:"created_at",label:"上传时间",width:"150"},{default:o(({row:t})=>[s(n(k(t.created_at)),1)]),_:1})]),_:1},8,["data"])]),_:1}),e(z,{label:"绿色分类变动轨迹",name:"category-trace"},{default:o(()=>[e(K,null,{default:o(()=>[(m(!0),v(q,null,I(w.value,t=>(m(),A(R,{key:t.id,timestamp:k(t.completed_at||t.started_at),placement:"top"},{default:o(()=>[e(B,null,{default:o(()=>[d("div",Me,[d("div",Ue,[d("span",Te,n(t.task_name),1),e(F,{type:H(t.status),size:"small"},{default:o(()=>[s(n(t.status),1)]),_:2},1032,["type"])]),t.formatted_category?(m(),v("div",$e,[a[18]||(a[18]=d("div",{class:"category-label"},"绿色金融支持项目目录:",-1)),d("div",Se,n(t.formatted_category),1)])):(m(),v("div",Fe,[...a[19]||(a[19]=[d("div",{class:"category-label"},"绿色金融支持项目目录:",-1),d("div",{class:"category-value"},"暂无分类信息",-1)])]))])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}},Pe=fe(Be,[["__scopeId","data-v-cfdd844c"]]);export{Pe as default};
