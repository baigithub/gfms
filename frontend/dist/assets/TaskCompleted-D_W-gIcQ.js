import{_ as se,p as le,n as ne,o as c,c as f,b as a,w as l,r as d,m as z,j as oe,d as ie,q as re,Q as ce,S as ue,s as C,i as u,t as n,a as i,F as I,y as P,I as _e,x as g,T as q,E as de,D as pe}from"./index-DDrUN6p6.js";import{f as me,a as fe,b as ve}from"./green_finance-B4o63B-q.js";import"./index-B2NntqTq.js";import"./index-D5GkNzM3.js";const ge={class:"task-page"},ye={class:"timeline-content"},he={class:"timeline-header"},be={class:"timeline-title"},ke={class:"timeline-detail"},we={key:0,class:"timeline-result"},ze={key:1,class:"timeline-comment"},Ce={key:2,class:"timeline-reason"},Te={class:"flow-chart"},De={key:0,class:"step-description"},Me={key:0,class:"step-description"},xe={key:0,class:"step-description"},Se={key:0,class:"step-description"},Ve={class:"category-trace"},je={class:"trace-header"},Ne={class:"trace-title"},Be={class:"trace-detail"},Ye={key:0},Ae={key:0,class:"trace-category"},Fe={class:"category-value"},Ue={key:1,class:"trace-category-empty"},Ee={__name:"TaskCompleted",setup($e){ie();const L=re(),S=z(!1),N=z([]),y=oe({page:1,page_size:10,total:0}),D=z(!1),V=z("business"),p=z({}),r=z([]),R=pe(()=>{if(!r.value||r.value.length===0)return 0;const e=r.value.filter(h=>h.status==="已完成");if(e.length===0)return 0;if(r.value.every(h=>h&&h.status==="已完成"))return 5;const o=e[e.length-1];return{manager_identification:1,branch_review:2,first_approval:3,final_review:4}[o.task_key]||1}),B=e=>e?Number(e).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",Y=e=>e?q(e).format("YYYY-MM-DD"):"-",b=e=>e?q(e).format("YYYY-MM-DD HH:mm:ss"):"-",A=e=>{if(e.formatted_category)return e.formatted_category;const s=[];return e.project_category_large&&s.push(e.project_category_large),e.project_category_medium&&s.push(e.project_category_medium),e.project_category_small&&s.push(e.project_category_small),s.join("/")||"-"},Q=e=>{if(!e)return"0 B";const s=1024,o=["B","KB","MB","GB"],_=Math.floor(Math.log(e)/Math.log(s));return Math.round(e/Math.pow(s,_)*100)/100+" "+o[_]},W=e=>{const o=`http://localhost:8000${e.download_url}`;window.open(o,"_blank")},J=e=>e==="已完成"?"success":e==="待处理"?"primary":e==="已撤回"?"info":"warning",F=e=>({待办:"warning",已办:"primary",办结:"success",驳回:"danger",撤回:"info"})[e]||"info",M=async()=>{S.value=!0;try{const e=await me({page:y.page,page_size:y.page_size});N.value=e.items,y.total=e.total}catch(e){console.error("Failed to load tasks:",e)}finally{S.value=!1}},O=async e=>{try{console.log("handleView called with row:",e);const[s,o]=await Promise.all([fe(e.task_id),ve(e.id)]);console.log("detail:",s),console.log("history:",o),p.value=s,r.value=o,D.value=!0,V.value="business"}catch(s){console.error("获取任务详情失败:",s),de.error("获取任务详情失败")}},x=e=>{if(!r.value||!Array.isArray(r.value))return{manager_identification:"客户经理认定",branch_review:"二级分行绿色金融管理岗",first_approval:"一级分行绿色金融管理岗",final_review:"绿色金融复核岗"}[e]||"未知节点";const s=r.value.find(_=>_&&_.task_key===e);return s&&s.task_name?s.task_name:{manager_identification:"客户经理认定",branch_review:"二级分行绿色金融管理岗",first_approval:"一级分行绿色金融管理岗",final_review:"绿色金融复核岗"}[e]||"未知节点"},m=e=>!r.value||!Array.isArray(r.value)?null:r.value.find(o=>o&&o.task_key===e&&o.completed_at),k=e=>{if(e==="start")return r.value&&r.value.some(_=>_&&_.status==="已完成")?"success":"wait";if(e==="end")return r.value&&r.value.every(_=>_&&_.status==="已完成")?"success":"wait";const s=m(e);return s&&s.status==="已完成"?"success":"wait"};return le(()=>{M()}),ne(()=>L.query.t,()=>{M()}),(e,s)=>{const o=d("el-table-column"),_=d("el-tag"),h=d("el-button"),U=d("el-table"),X=d("el-pagination"),j=d("el-card"),v=d("el-descriptions-item"),Z=d("el-descriptions"),T=d("el-tab-pane"),E=d("el-timeline-item"),$=d("el-timeline"),w=d("el-step"),K=d("el-steps"),G=d("el-empty"),ee=d("el-tabs"),te=d("el-dialog"),ae=ce("loading");return c(),f("div",ge,[a(j,{shadow:"hover"},{header:l(()=>[...s[5]||(s[5]=[i("div",{class:"card-header"},[i("span",{class:"card-title"},"已办任务")],-1)])]),default:l(()=>[ue((c(),C(U,{data:N.value,stripe:"",style:{width:"100%"}},{default:l(()=>[a(o,{type:"index",label:"序号",width:"60"}),a(o,{prop:"customer_name",label:"客户名称","min-width":"150"}),a(o,{prop:"business_type",label:"业务品种",width:"150"}),a(o,{prop:"loan_account",label:"贷款账号",width:"150"}),a(o,{prop:"loan_amount",label:"放款金额(元)",width:"120"},{default:l(({row:t})=>[u(n(B(t.loan_amount)),1)]),_:1}),a(o,{prop:"disbursement_date",label:"放款日",width:"120"},{default:l(({row:t})=>[u(n(Y(t.disbursement_date)),1)]),_:1}),a(o,{label:"绿色金融支持项目目录","min-width":"250"},{default:l(({row:t})=>[u(n(A(t)),1)]),_:1}),a(o,{prop:"status",label:"状态",width:"100"},{default:l(({row:t})=>[a(_,{type:F(t.status),size:"small"},{default:l(()=>[u(n(t.status),1)]),_:2},1032,["type"])]),_:1}),a(o,{label:"操作",width:"120",fixed:"right"},{default:l(({row:t})=>[a(h,{type:"primary",link:"",size:"small",onClick:H=>O(t)},{default:l(()=>[...s[6]||(s[6]=[u(" 查看 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ae,S.value]]),a(X,{"current-page":y.page,"onUpdate:currentPage":s[0]||(s[0]=t=>y.page=t),"page-size":y.page_size,"onUpdate:pageSize":s[1]||(s[1]=t=>y.page_size=t),total:y.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:M,onCurrentChange:M,style:{"margin-top":"20px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"])]),_:1}),a(te,{modelValue:D.value,"onUpdate:modelValue":s[4]||(s[4]=t=>D.value=t),title:"任务详情",width:"900px"},{footer:l(()=>[a(h,{onClick:s[3]||(s[3]=t=>D.value=!1)},{default:l(()=>[...s[10]||(s[10]=[u("关闭",-1)])]),_:1})]),default:l(()=>[a(ee,{modelValue:V.value,"onUpdate:modelValue":s[2]||(s[2]=t=>V.value=t)},{default:l(()=>[a(T,{label:"业务信息",name:"business"},{default:l(()=>[a(Z,{column:2,border:""},{default:l(()=>[a(v,{label:"贷款编号"},{default:l(()=>[u(n(p.value.loan_code),1)]),_:1}),a(v,{label:"客户名称"},{default:l(()=>[u(n(p.value.customer_name),1)]),_:1}),a(v,{label:"业务品种"},{default:l(()=>[u(n(p.value.business_type),1)]),_:1}),a(v,{label:"贷款账号"},{default:l(()=>[u(n(p.value.loan_account),1)]),_:1}),a(v,{label:"放款金额"},{default:l(()=>[u(n(B(p.value.loan_amount)),1)]),_:1}),a(v,{label:"放款日期"},{default:l(()=>[u(n(Y(p.value.disbursement_date)),1)]),_:1}),a(v,{label:"绿色金融支持项目目录",span:2},{default:l(()=>[u(n(A(p.value)),1)]),_:1}),a(v,{label:"ESG风险等级"},{default:l(()=>[u(n(p.value.esg_risk_level),1)]),_:1}),a(v,{label:"ESG表现等级"},{default:l(()=>[u(n(p.value.esg_performance_level),1)]),_:1})]),_:1})]),_:1}),a(T,{label:"审批记录",name:"approval"},{default:l(()=>[a($,null,{default:l(()=>[(c(!0),f(I,null,P(r.value,t=>(c(),C(E,{key:t.id,timestamp:b(t.completed_at||t.started_at),placement:"top"},{default:l(()=>[a(j,null,{default:l(()=>[i("div",ye,[i("div",he,[i("span",be,n(t.task_name),1),a(_,{type:F(t.status),size:"small"},{default:l(()=>[u(n(t.status),1)]),_:2},1032,["type"])]),i("div",ke,[i("span",null,"审批人: "+n(t.assignee_name),1),i("span",null,"岗位: "+n(t.position_name),1)]),t.approval_result?(c(),f("div",we,[s[7]||(s[7]=i("span",null,"审批结果: ",-1)),i("span",{class:_e(t.approval_result==="同意"?"result-agree":"result-disagree")},n(t.approval_result),3)])):g("",!0),t.comment?(c(),f("div",ze,[i("span",null,"意见: "+n(t.comment),1)])):g("",!0),t.reason?(c(),f("div",Ce,[i("span",null,"原因: "+n(t.reason),1)])):g("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1}),a(T,{label:"流程跟踪",name:"flow"},{default:l(()=>[i("div",Te,[a(K,{active:R.value,"align-center":"","finish-status":"success"},{default:l(()=>[a(w,{title:"开始",status:k("start")},null,8,["status"]),a(w,{title:x("manager_identification")||"客户经理认定",status:k("manager_identification")},{description:l(()=>[m("manager_identification")?(c(),f("div",De," 由 "+n(m("manager_identification").assignee_name)+" 于 "+n(b(m("manager_identification").completed_at))+" 提交 ",1)):g("",!0)]),_:1},8,["title","status"]),a(w,{title:x("branch_review")||"二级分行绿色金融管理岗",status:k("branch_review")},{description:l(()=>[m("branch_review")?(c(),f("div",Me," 由 "+n(m("branch_review").assignee_name)+" 于 "+n(b(m("branch_review").completed_at))+" 提交 ",1)):g("",!0)]),_:1},8,["title","status"]),a(w,{title:x("first_approval")||"一级分行绿色金融管理岗",status:k("first_approval")},{description:l(()=>[m("first_approval")?(c(),f("div",xe," 由 "+n(m("first_approval").assignee_name)+" 于 "+n(b(m("first_approval").completed_at))+" 提交 ",1)):g("",!0)]),_:1},8,["title","status"]),a(w,{title:x("final_review")||"绿色金融复核岗",status:k("final_review")},{description:l(()=>[m("final_review")?(c(),f("div",Se," 由 "+n(m("final_review").assignee_name)+" 于 "+n(b(m("final_review").completed_at))+" 提交 ",1)):g("",!0)]),_:1},8,["title","status"]),a(w,{title:"结束",status:k("end")},null,8,["status"])]),_:1},8,["active"])])]),_:1}),a(T,{label:"附件列表",name:"attachments"},{default:l(()=>[p.value.attachments&&p.value.attachments.length>0?(c(),C(U,{key:0,data:p.value.attachments||[],stripe:"",size:"small"},{default:l(()=>[a(o,{prop:"task_name",label:"所属节点",width:"150"}),a(o,{prop:"uploader_name",label:"上传人",width:"120"}),a(o,{prop:"original_filename",label:"附件名称","min-width":"200"},{default:l(({row:t})=>[a(h,{type:"primary",link:"",size:"small",onClick:H=>W(t)},{default:l(()=>[u(n(t.original_filename),1)]),_:2},1032,["onClick"])]),_:1}),a(o,{prop:"file_size",label:"文件大小",width:"100"},{default:l(({row:t})=>[u(n(Q(t.file_size)),1)]),_:1}),a(o,{prop:"created_at",label:"上传时间",width:"160"})]),_:1},8,["data"])):(c(),C(G,{key:1,description:"暂无附件","image-size":60}))]),_:1}),a(T,{label:"绿色分类变动轨迹",name:"category-trace"},{default:l(()=>[i("div",Ve,[a($,null,{default:l(()=>[(c(!0),f(I,null,P(r.value,(t,H)=>(c(),C(E,{key:t.id,timestamp:b(t.completed_at||t.started_at),placement:"top",type:J(t.status)},{default:l(()=>[a(j,{shadow:"hover",class:"trace-card"},{default:l(()=>[i("div",je,[i("span",Ne,n(t.task_name),1),a(_,{size:"small"},{default:l(()=>[u(n(t.status),1)]),_:2},1024)]),i("div",Be,[i("span",null,"办理人: "+n(t.assignee_name),1),t.assignee_username?(c(),f("span",Ye,"账号: "+n(t.assignee_username),1)):g("",!0)]),t.formatted_category?(c(),f("div",Ae,[s[8]||(s[8]=i("div",{class:"category-label"},"绿色金融支持项目目录:",-1)),i("div",Fe,n(t.formatted_category),1)])):(c(),f("div",Ue,[...s[9]||(s[9]=[i("span",null,"暂无分类信息",-1)])]))]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1}),!r.value||r.value.length===0?(c(),C(G,{key:0,description:"暂无分类变动轨迹"})):g("",!0)])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["modelValue"])])}}},qe=se(Ee,[["__scopeId","data-v-d8d282bf"]]);export{qe as default};
