import{_ as ge,s as ve,o as h,c as z,b as e,w as t,r as u,p as b,n as K,$ as ye,a as n,e as c,g as J,z as be,D as S,f as A,aa as he,m as r,a6 as we,a1 as je,i as G,t as s,a3 as Ve,ab as ke,S as De,F as X,y as Z,ac as Ce,O as ze,j as H,ad as Ye,ae as Me,af as Ue,a2 as ee,E as B,u as xe}from"./index-D4Rku7DI.js";import{F as $e}from"./FlowChart-CWbDuyhS.js";import{i as Fe,a as Se,b as Ae,c as Be}from"./green_finance-C_pmG5wr.js";import"./index-VufPjWZz.js";import"./index-D5GkNzM3.js";const Te={class:"task-page"},Re={class:"card-header"},Ee={class:"header-left"},Le={class:"header-right"},Ne={class:"search-form-container"},Ge={class:"index-badge"},He={class:"customer-name"},Oe={class:"amount-value"},Pe={class:"date-value"},Ie={class:"project-category-wrap"},qe={class:"date-value"},Qe={class:"assignee-name"},We={class:"date-value"},Ke={class:"pagination-container"},Je={class:"detail-content"},Xe={class:"category-display"},Ze={class:"timeline-content"},et={class:"timeline-header"},tt={class:"timeline-title"},at={class:"timeline-detail"},lt={class:"timeline-item"},ot={class:"timeline-item"},st={key:0,class:"timeline-result"},nt={key:1,class:"timeline-comment"},rt={class:"timeline-item"},it={key:2,class:"timeline-reason"},dt={class:"timeline-item"},ut={class:"uploader-name"},ct={class:"timeline-content"},_t={class:"timeline-header"},pt={class:"timeline-title"},mt={class:"trace-category"},ft={class:"category-label"},gt={class:"category-value"},vt={__name:"TaskArchived",setup(yt){const Y=b(!1),O=b([]),f=K({page:1,page_size:10,total:0}),d=K({customer_name:"",business_type:"",loan_account:"",initiator:"",project_category:""}),V=b([]),k=b([]),D=b([]),$=b(!1),T=b("business"),m=b({}),F=b([]),R=b(null),P=o=>o?Number(o).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",E=o=>o?ee(o).format("YYYY-MM-DD"):"-",M=o=>o?ee(o).format("YYYY-MM-DD HH:mm:ss"):"-",I=o=>({待处理:"warning",已完成:"success",已撤回:"info"})[o]||"info",te=o=>{if(o.formatted_category)return o.formatted_category;const l=[];return o.project_category_large&&l.push(o.project_category_large),o.project_category_medium&&l.push(o.project_category_medium),o.project_category_small&&l.push(o.project_category_small),l.join("/")||"-"},ae=o=>{const l=[];return o.project_category_large_code&&o.project_category_large?l.push(`${o.project_category_large_code} ${o.project_category_large}`):o.project_category_large&&l.push(o.project_category_large),o.project_category_medium_code&&o.project_category_medium?l.push(`${o.project_category_medium_code} ${o.project_category_medium}`):o.project_category_medium&&l.push(o.project_category_medium),o.project_category_small_code&&o.project_category_small?l.push(`${o.project_category_small_code} ${o.project_category_small}`):o.project_category_small&&l.push(o.project_category_small),l.join("/")||"-"},le=o=>{if(!o)return"-";const l=1024,i=["B","KB","MB","GB"],p=Math.floor(Math.log(o)/Math.log(l));return(o/Math.pow(l,p)).toFixed(2)+" "+i[p]},oe=async o=>{try{const i=xe().token;if(!i){B.error("未登录,请先登录");return}const w=`http://localhost:8000${o.download_url}`,j=await fetch(w,{headers:{Authorization:`Bearer ${i}`}});if(!j.ok)throw new Error(`下载失败: ${j.status}`);const g=await j.blob(),U=window.URL.createObjectURL(g),v=document.createElement("a");v.href=U,v.download=o.original_filename,v.style.display="none",v.target="_blank",v.rel="noopener noreferrer",document.body.appendChild(v),v.click(),document.body.removeChild(v),window.URL.revokeObjectURL(U),B.success("下载成功")}catch(l){console.error("下载失败:",l),B.error("下载失败")}},se=()=>{const o={page:f.page,page_size:f.page_size};return d.customer_name&&(o.customer_name=d.customer_name),d.business_type&&(o.business_type=d.business_type),d.loan_account&&(o.loan_account=d.loan_account),d.initiator&&(o.initiator=d.initiator),d.project_category&&(o.project_category=d.project_category),V.value&&V.value.length===2&&(o.disbursement_date_start=V.value[0],o.disbursement_date_end=V.value[1]),k.value&&k.value.length===2&&(o.completed_date_start=k.value[0],o.completed_date_end=k.value[1]),D.value&&D.value.length===2&&(o.deadline_start=D.value[0],o.deadline_end=D.value[1]),o},C=async()=>{Y.value=!0;try{const o=se(),l=await Fe(o);O.value=l.items,f.total=l.total}catch(o){console.error("Failed to load tasks:",o)}finally{Y.value=!1}},ne=()=>{f.page=1,C()},re=()=>{Object.assign(d,{customer_name:"",business_type:"",loan_account:"",initiator:"",project_category:""}),V.value=[],k.value=[],D.value=[],f.page=1,C()},ie=async o=>{try{const[l,i]=await Promise.all([Se(o.task_id),Ae(o.identification_id)]);m.value=l,F.value=i;try{const p=await Be(o.identification_id);R.value=(p==null?void 0:p.process_definition_id)||null}catch(p){console.warn("获取工作流实例失败:",p),R.value=null}$.value=!0,T.value="business"}catch{B.error("获取任务详情失败")}};return ve(()=>{C()}),(o,l)=>{const i=u("el-icon"),p=u("el-tag"),w=u("el-button"),j=u("el-input"),g=u("el-form-item"),U=u("el-option"),v=u("el-select"),L=u("el-date-picker"),de=u("el-form"),_=u("el-table-column"),q=u("el-table"),ue=u("el-pagination"),N=u("el-card"),y=u("el-descriptions-item"),ce=u("el-descriptions"),x=u("el-tab-pane"),Q=u("el-timeline-item"),W=u("el-timeline"),_e=u("el-tabs"),pe=u("el-dialog"),me=ye("loading");return h(),z("div",Te,[e(N,{shadow:"never"},{header:t(()=>[n("div",Re,[n("div",Ee,[e(i,{class:"header-icon",color:"#667eea"},{default:t(()=>[e(c(ke))]),_:1}),l[13]||(l[13]=n("span",{class:"card-title"},"办结任务",-1)),e(p,{type:"success",size:"small"},{default:t(()=>[r(s(f.total)+" 条记录",1)]),_:1})]),n("div",Le,[e(w,{onClick:C,loading:Y.value},{default:t(()=>[e(i,null,{default:t(()=>[e(c(De))]),_:1}),l[14]||(l[14]=r(" 刷新 ",-1))]),_:1},8,["loading"])])])]),default:t(()=>[n("div",Ne,[e(de,{model:d,inline:"",class:"query-form"},{default:t(()=>[e(g,{label:"客户名称"},{default:t(()=>[e(j,{modelValue:d.customer_name,"onUpdate:modelValue":l[0]||(l[0]=a=>d.customer_name=a),placeholder:"请输入",clearable:"",class:"modern-input"},{prefix:t(()=>[e(i,null,{default:t(()=>[e(c(J))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(g,{label:"业务品种"},{default:t(()=>[e(v,{modelValue:d.business_type,"onUpdate:modelValue":l[1]||(l[1]=a=>d.business_type=a),placeholder:"请选择",clearable:"",class:"modern-input"},{default:t(()=>[e(U,{label:"一般性固定资产贷款",value:"一般性固定资产贷款"}),e(U,{label:"法人账户透支",value:"法人账户透支"})]),_:1},8,["modelValue"])]),_:1}),e(g,{label:"贷款账号"},{default:t(()=>[e(j,{modelValue:d.loan_account,"onUpdate:modelValue":l[2]||(l[2]=a=>d.loan_account=a),placeholder:"请输入",clearable:"",class:"modern-input"},{prefix:t(()=>[e(i,null,{default:t(()=>[e(c(be))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(g,{label:"发起人"},{default:t(()=>[e(j,{modelValue:d.initiator,"onUpdate:modelValue":l[3]||(l[3]=a=>d.initiator=a),placeholder:"请输入",clearable:"",class:"modern-input"},{prefix:t(()=>[e(i,null,{default:t(()=>[e(c(S))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(g,{label:"项目目录"},{default:t(()=>[e(j,{modelValue:d.project_category,"onUpdate:modelValue":l[4]||(l[4]=a=>d.project_category=a),placeholder:"请输入",clearable:"",class:"modern-input"},{prefix:t(()=>[e(i,null,{default:t(()=>[e(c(A))]),_:1})]),_:1},8,["modelValue"])]),_:1}),e(g,{label:"放款日期"},{default:t(()=>[e(L,{modelValue:V.value,"onUpdate:modelValue":l[5]||(l[5]=a=>V.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",class:"modern-input"},null,8,["modelValue"])]),_:1}),e(g,{label:"办结时间"},{default:t(()=>[e(L,{modelValue:k.value,"onUpdate:modelValue":l[6]||(l[6]=a=>k.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",class:"modern-input"},null,8,["modelValue"])]),_:1}),e(g,{label:"截止日期"},{default:t(()=>[e(L,{modelValue:D.value,"onUpdate:modelValue":l[7]||(l[7]=a=>D.value=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",class:"modern-input"},null,8,["modelValue"])]),_:1}),e(g,{class:"search-buttons"},{default:t(()=>[e(w,{type:"primary",onClick:ne,loading:Y.value},{default:t(()=>[e(i,null,{default:t(()=>[e(c(he))]),_:1}),l[15]||(l[15]=r(" 查询 ",-1))]),_:1},8,["loading"]),e(w,{onClick:re},{default:t(()=>[e(i,null,{default:t(()=>[e(c(we))]),_:1}),l[16]||(l[16]=r(" 重置 ",-1))]),_:1})]),_:1})]),_:1},8,["model"])]),je((h(),G(q,{data:O.value,stripe:"","show-header":"",style:{width:"100%"},class:"modern-table"},{default:t(()=>[e(_,{type:"index",label:"序号",width:"80",align:"center"},{default:t(({$index:a})=>[n("div",Ge,s(a+1),1)]),_:1}),e(_,{prop:"customer_name",label:"客户名称","min-width":"150","show-overflow-tooltip":""},{default:t(({row:a})=>[n("div",He,[e(i,null,{default:t(()=>[e(c(J))]),_:1}),r(" "+s(a.customer_name),1)])]),_:1}),e(_,{prop:"business_type",label:"业务品种",width:"150"},{default:t(({row:a})=>[e(p,{type:"primary",effect:"plain"},{default:t(()=>[r(s(a.business_type),1)]),_:2},1024)]),_:1}),e(_,{prop:"loan_account",label:"贷款账号",width:"150"}),e(_,{prop:"loan_amount",label:"放款金额(元)",width:"140",align:"right"},{default:t(({row:a})=>[n("div",Oe,s(P(a.loan_amount)),1)]),_:1}),e(_,{prop:"disbursement_date",label:"放款日",width:"120",align:"center"},{default:t(({row:a})=>[n("div",Pe,s(E(a.disbursement_date)),1)]),_:1}),e(_,{label:"绿色金融支持项目目录","min-width":"250"},{default:t(({row:a})=>[n("div",Ie,[e(i,{color:"#4CAF50"},{default:t(()=>[e(c(A))]),_:1}),n("span",null,s(te(a)),1)])]),_:1}),l[18]||(l[18]=r()),e(_,{prop:"deadline",label:"截止日期",width:"120",align:"center"},{default:t(({row:a})=>[n("div",qe,s(a.deadline?E(a.deadline):"-"),1)]),_:1}),e(_,{prop:"status",label:"状态",width:"100",align:"center"},{default:t(({row:a})=>[e(p,{type:"success",effect:"plain"},{default:t(()=>[r(s(a.status),1)]),_:2},1024)]),_:1}),e(_,{prop:"initiator_name",label:"发起人",width:"120"},{default:t(({row:a})=>[n("div",Qe,[e(i,null,{default:t(()=>[e(c(S))]),_:1}),r(" "+s(a.initiator_name),1)])]),_:1}),e(_,{prop:"completed_at",label:"办结时间",width:"160",align:"center"},{default:t(({row:a})=>[n("div",We,s(M(a.completed_at)),1)]),_:1}),e(_,{label:"操作",width:"100",fixed:"right",align:"center"},{default:t(({row:a})=>[e(w,{type:"primary",link:"",onClick:fe=>ie(a),class:"action-button"},{default:t(()=>[e(i,null,{default:t(()=>[e(c(Ve))]),_:1}),l[17]||(l[17]=r(" 查看 ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[me,Y.value]]),n("div",Ke,[e(ue,{"current-page":f.page,"onUpdate:currentPage":l[8]||(l[8]=a=>f.page=a),"page-size":f.page_size,"onUpdate:pageSize":l[9]||(l[9]=a=>f.page_size=a),total:f.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:C,onCurrentChange:C},null,8,["current-page","page-size","total"])])]),_:1}),e(pe,{modelValue:$.value,"onUpdate:modelValue":l[12]||(l[12]=a=>$.value=a),title:"任务详情",width:"900px",class:"detail-dialog"},{footer:t(()=>[e(w,{onClick:l[11]||(l[11]=a=>$.value=!1)},{default:t(()=>[...l[21]||(l[21]=[r("关闭",-1)])]),_:1})]),default:t(()=>[n("div",Je,[e(_e,{modelValue:T.value,"onUpdate:modelValue":l[10]||(l[10]=a=>T.value=a),class:"detail-tabs"},{default:t(()=>[e(x,{label:"业务信息",name:"business"},{default:t(()=>[e(ce,{column:2,border:"",class:"detail-descriptions"},{default:t(()=>[e(y,{label:"贷款编号"},{default:t(()=>[r(s(m.value.loan_code),1)]),_:1}),e(y,{label:"客户名称"},{default:t(()=>[r(s(m.value.customer_name),1)]),_:1}),e(y,{label:"业务品种"},{default:t(()=>[r(s(m.value.business_type),1)]),_:1}),e(y,{label:"贷款账号"},{default:t(()=>[r(s(m.value.loan_account),1)]),_:1}),e(y,{label:"放款金额"},{default:t(()=>[r(s(P(m.value.loan_amount)),1)]),_:1}),e(y,{label:"放款日期"},{default:t(()=>[r(s(E(m.value.disbursement_date)),1)]),_:1}),e(y,{label:"绿色金融支持项目目录",span:2},{default:t(()=>[n("div",Xe,[e(i,{color:"#4CAF50"},{default:t(()=>[e(c(A))]),_:1}),r(" "+s(m.value.formatted_category||ae(m.value)),1)])]),_:1}),e(y,{label:"ESG风险等级"},{default:t(()=>[r(s(m.value.esg_risk_level),1)]),_:1}),e(y,{label:"ESG表现等级"},{default:t(()=>[r(s(m.value.esg_performance_level),1)]),_:1}),e(y,{label:"办结时间",span:2},{default:t(()=>[r(s(M(m.value.completed_at)),1)]),_:1})]),_:1})]),_:1}),e(x,{label:"审批记录",name:"approval"},{default:t(()=>[e(W,{class:"timeline-container"},{default:t(()=>[(h(!0),z(X,null,Z(F.value,a=>(h(),G(Q,{key:a.id,timestamp:M(a.completed_at||a.started_at),placement:"top"},{default:t(()=>[e(N,{shadow:"never",class:"timeline-card"},{default:t(()=>[n("div",Ze,[n("div",et,[n("span",tt,s(a.task_name),1),e(p,{type:I(a.status),size:"small",effect:"plain"},{default:t(()=>[r(s(a.status),1)]),_:2},1032,["type"])]),n("div",at,[n("span",lt,[e(i,null,{default:t(()=>[e(c(S))]),_:1}),r(" 审批人: "+s(a.assignee_name),1)]),n("span",ot,[e(i,null,{default:t(()=>[e(c(Ce))]),_:1}),r(" 岗位: "+s(a.position_name),1)])]),a.approval_result?(h(),z("div",st,[l[19]||(l[19]=n("span",null,"审批结果: ",-1)),n("span",{class:ze(a.approval_result==="同意"?"result-agree":"result-disagree")},s(a.approval_result),3)])):H("",!0),a.comment?(h(),z("div",nt,[n("span",rt,[e(i,null,{default:t(()=>[e(c(Ye))]),_:1}),r(" 意见: "+s(a.comment),1)])])):H("",!0),a.reason?(h(),z("div",it,[n("span",dt,[e(i,null,{default:t(()=>[e(c(Me))]),_:1}),r(" 原因: "+s(a.reason),1)])])):H("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1}),e(x,{label:"流程跟踪",name:"flow"},{default:t(()=>[e($e,{"workflow-history":F.value,"process-definition-id":R.value},null,8,["workflow-history","process-definition-id"])]),_:1}),e(x,{label:"附件列表",name:"attachments"},{default:t(()=>[e(q,{data:m.value.attachments||[],stripe:"",size:"small",class:"attachment-table"},{default:t(()=>[e(_,{prop:"task_name",label:"所属节点",width:"150"}),e(_,{prop:"uploader_name",label:"上传人",width:"120"},{default:t(({row:a})=>[n("div",ut,[e(i,null,{default:t(()=>[e(c(S))]),_:1}),r(" "+s(a.uploader_name),1)])]),_:1}),e(_,{prop:"original_filename",label:"附件名称"},{default:t(({row:a})=>[e(w,{type:"primary",link:"",onClick:fe=>oe(a),class:"file-link"},{default:t(()=>[e(i,null,{default:t(()=>[e(c(Ue))]),_:1}),r(" "+s(a.original_filename),1)]),_:2},1032,["onClick"])]),_:1}),e(_,{prop:"file_size",label:"文件大小",width:"100",align:"right"},{default:t(({row:a})=>[r(s(le(a.file_size)),1)]),_:1}),e(_,{prop:"created_at",label:"上传时间",width:"150",align:"center"},{default:t(({row:a})=>[r(s(M(a.created_at)),1)]),_:1})]),_:1},8,["data"])]),_:1}),e(x,{label:"绿色分类变动轨迹",name:"category-trace"},{default:t(()=>[e(W,{class:"timeline-container"},{default:t(()=>[(h(!0),z(X,null,Z(F.value,a=>(h(),G(Q,{key:a.id,timestamp:M(a.completed_at||a.started_at),placement:"top"},{default:t(()=>[e(N,{shadow:"never",class:"timeline-card"},{default:t(()=>[n("div",ct,[n("div",_t,[n("span",pt,s(a.task_name),1),e(p,{type:I(a.status),size:"small",effect:"plain"},{default:t(()=>[r(s(a.status),1)]),_:2},1032,["type"])]),n("div",mt,[n("div",ft,[e(i,{color:"#4CAF50"},{default:t(()=>[e(c(A))]),_:1}),l[20]||(l[20]=r(" 绿色金融支持项目目录: ",-1))]),n("div",gt,s(a.formatted_category||"暂无分类信息"),1)])])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})]),_:1})]),_:1},8,["modelValue"])])]),_:1},8,["modelValue"])])}}},kt=ge(vt,[["__scopeId","data-v-2182919c"]]);export{kt as default};
