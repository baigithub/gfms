import{_ as j,p as G,o as p,c as D,b as t,w as n,E as c,r as d,m as u,d as L,F as O,y as R,s as h,i as r,t as m,x as V,a as _,G as g}from"./index-DDrUN6p6.js";import{b as A,g as H,d as J,e as K,f as P}from"./workflow-DQgkmHMg.js";import"./index-D5GkNzM3.js";const Q={class:"workflow-management"},X={class:"card-header"},Y={class:"group-title"},Z={class:"process-name"},ee={class:"process-count"},te={__name:"WorkflowManagement",setup(ae){const f=L(),x=u([]),v=u([]),b=u([]),$=u([]),C=u(!1),y=async()=>{try{const a=await A({page:1,page_size:100});x.value=a||[];const e={};x.value.forEach(o=>{e[o.name]||(e[o.name]={name:o.name,versions:[]}),e[o.name].versions.push(o)}),v.value=Object.values(e).map(o=>({name:o.name,versions:o.versions.sort((s,w)=>w.version-s.version)})),v.value.length>0&&(b.value=[v.value[0].name])}catch{c.error("加载流程列表失败")}},T=()=>{f.push("/workflow/designer")},M=a=>{f.push({path:"/workflow/designer",query:{mode:"view",id:a.id}})},z=async a=>{try{const e=await H(a.id);e.instance_count&&e.instance_count>0?(await g.confirm(`当前流程版本已绑定 ${e.instance_count} 个流程实例，是否创建新版本？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info",customClass:"instance-bound-confirm"}),f.push({path:"/workflow/designer",query:{mode:"new",copyFrom:a.id}})):f.push({path:"/workflow/designer",query:{mode:"edit",id:a.id}})}catch(e){e!=="cancel"&&c.error("获取流程定义详情失败")}},E=async a=>{try{await g.confirm(`确定要删除流程 "${a.name}" 吗？此操作不可恢复。`,"删除确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await P(a.id),c.success("流程删除成功"),y()}catch(e){e!=="cancel"&&c.error("流程删除失败")}},N=async a=>{try{await g.confirm(`确定要启用流程 "${a.name} v${a.version}" 吗？这将停用同一名称下的其他启用版本。`,"启用确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"info"}),await K(a.id),c.success("流程启用成功"),y()}catch(e){e!=="cancel"&&c.error("流程启用失败")}},W=async a=>{var e,o;try{await g.confirm(`确定要停用流程 "${a.name} v${a.version}" 吗？`,"停用确认",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await J(a.id),c.success("流程停用成功"),y()}catch(s){s!=="cancel"&&c.error(((o=(e=s.response)==null?void 0:e.data)==null?void 0:o.detail)||"流程停用失败")}},q=a=>({active:"已启用",archived:"已停用"})[a]||a;return G(()=>{y()}),(a,e)=>{const o=d("el-button"),s=d("el-table-column"),w=d("el-tag"),B=d("el-table"),F=d("el-collapse-item"),I=d("el-collapse"),S=d("el-card"),U=d("el-dialog");return p(),D("div",Q,[t(S,null,{header:n(()=>[_("div",X,[e[3]||(e[3]=_("span",null,"流程管理",-1)),t(o,{type:"primary",onClick:T},{default:n(()=>[...e[2]||(e[2]=[r("新建流程",-1)])]),_:1})])]),default:n(()=>[t(I,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=l=>b.value=l),accordion:""},{default:n(()=>[(p(!0),D(O,null,R(v.value,l=>(p(),h(F,{key:l.name,name:l.name},{title:n(()=>[_("div",Y,[_("span",Z,m(l.name),1),_("span",ee,"("+m(l.versions.length)+" 个版本)",1)])]),default:n(()=>[t(B,{data:l.versions,stripe:""},{default:n(()=>[t(s,{prop:"id",label:"ID",width:"80"}),t(s,{prop:"key",label:"流程键",width:"180"}),t(s,{prop:"name",label:"流程名称",width:"200"}),t(s,{label:"版本",width:"100"},{default:n(({row:i})=>[r(" v"+m(i.version),1)]),_:1}),t(s,{prop:"description",label:"描述"}),t(s,{prop:"status",label:"状态",width:"100"},{default:n(({row:i})=>[t(w,{type:i.status==="active"?"success":"danger"},{default:n(()=>[r(m(q(i.status)),1)]),_:2},1032,["type"])]),_:1}),t(s,{prop:"deployed_at",label:"部署时间",width:"180"}),t(s,{label:"操作",width:"280",fixed:"right"},{default:n(({row:i})=>[t(o,{type:"primary",link:"",size:"small",onClick:k=>M(i)},{default:n(()=>[...e[4]||(e[4]=[r("查看",-1)])]),_:1},8,["onClick"]),t(o,{type:"primary",link:"",size:"small",onClick:k=>z(i)},{default:n(()=>[...e[5]||(e[5]=[r("编辑",-1)])]),_:1},8,["onClick"]),i.status==="active"?(p(),h(o,{key:0,type:"warning",link:"",size:"small",onClick:k=>W(i)},{default:n(()=>[...e[6]||(e[6]=[r("停用",-1)])]),_:1},8,["onClick"])):V("",!0),i.status!=="active"?(p(),h(o,{key:1,type:"success",link:"",size:"small",onClick:k=>N(i)},{default:n(()=>[...e[7]||(e[7]=[r("启用",-1)])]),_:1},8,["onClick"])):V("",!0),t(o,{type:"danger",link:"",size:"small",onClick:k=>E(i)},{default:n(()=>[...e[8]||(e[8]=[r("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(U,{modelValue:C.value,"onUpdate:modelValue":e[1]||(e[1]=l=>C.value=l),title:"流程节点",width:"800px"},{default:n(()=>[t(B,{data:$.value,stripe:""},{default:n(()=>[t(s,{prop:"sequence",label:"顺序",width:"80"}),t(s,{prop:"node_id",label:"节点ID",width:"150"}),t(s,{prop:"node_name",label:"节点名称",width:"200"}),t(s,{prop:"node_type",label:"节点类型",width:"120"}),t(s,{prop:"is_skip_if_empty",label:"无人员跳过",width:"100"},{default:n(({row:l})=>[t(w,{type:l.is_skip_if_empty?"success":"danger"},{default:n(()=>[r(m(l.is_skip_if_empty?"是":"否"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])]),_:1},8,["modelValue"])])}}},le=j(te,[["__scopeId","data-v-f32c52c5"]]);export{le as default};
