import{_ as ge,s as ve,o as w,c as D,b as e,w as t,r as c,p as k,E as x,n as K,$ as be,a as d,a1 as P,e as m,g as Z,z as he,ag as ye,aa as q,m as s,a6 as we,i as M,I as ke,t as n,D as R,a3 as xe,af as W,Z as Ve,ah as ze,a4 as Ue,F as Ce,y as De,ad as Me,j as A,f as Se,a2 as Be,u as Le}from"./index-D4Rku7DI.js";import{j as Re,k as je}from"./green_finance-C_pmG5wr.js";import"./index-VufPjWZz.js";import"./index-D5GkNzM3.js";const Fe={class:"task-page"},Te={class:"card-header"},Ne={class:"header-left"},Ye={class:"header-right"},$e={class:"export-group"},Ae={class:"search-form-container"},Ee={class:"search-actions"},Oe={class:"action-buttons"},He={class:"index-badge"},Ie={class:"customer-name"},Je={class:"amount-value"},Qe={class:"date-value"},Ge={class:"assignee-name"},Ke={class:"date-value"},Pe={class:"pagination-container"},Ze={class:"detail-content"},qe={class:"divider-title"},We={class:"approver-name"},Xe={class:"divider-title"},et={key:0},tt={class:"uploader-name"},at={class:"divider-title"},lt={class:"trace-header"},ot={class:"trace-title"},st={class:"trace-detail"},nt={class:"trace-item"},rt={key:0,class:"trace-comment"},dt={class:"trace-item"},it={key:1,class:"trace-category"},ut={class:"category-label"},ct={class:"category-value"},_t={__name:"TaskQuery",setup(pt){const S=k(!1),j=k(!1),F=k(1e4),T=k(!1),z=k(!0),X=()=>{z.value=!z.value},E=k([]),y=K({page:1,page_size:10,total:0}),o=K({customer_name:"",business_type:"",loan_account:"",loan_date_range:[],status:""}),N=k(!1),_=k({}),O=r=>r?Number(r).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",ee=r=>{if(!r)return"0 B";const l=1024,u=["B","KB","MB","GB"],i=Math.floor(Math.log(r)/Math.log(l));return Math.round(r/Math.pow(l,i)*100)/100+" "+u[i]},te=async r=>{try{const u=Le().token;if(!u){x.error("未登录,请先登录");return}const h=`http://localhost:8000${r.download_url}`,g=await fetch(h,{headers:{Authorization:`Bearer ${u}`}});if(!g.ok)throw new Error(`下载失败: ${g.status}`);const f=await g.blob(),U=window.URL.createObjectURL(f),v=document.createElement("a");v.href=U,v.download=r.original_filename,v.style.display="none",v.target="_blank",v.rel="noopener noreferrer",document.body.appendChild(v),v.click(),document.body.removeChild(v),window.URL.revokeObjectURL(U),x.success("下载成功")}catch(l){console.error("下载失败:",l),x.error("下载失败")}},ae=r=>r==="已完成"||r==="已办结"?"success":r==="待处理"?"primary":r==="已撤回"?"info":"warning",B=r=>({待处理:"warning",审核中:"primary",已办结:"success",已撤回:"info",已提交:"info",已完成:"success",驳回:"danger",办结:"success"})[r]||"info",L=async()=>{S.value=!0;try{const r={page:y.page,page_size:y.page_size};o.customer_name&&(r.customer_name=o.customer_name),o.business_type&&(r.business_type=o.business_type),o.loan_account&&(r.loan_account=o.loan_account),o.loan_date_range&&o.loan_date_range.length===2&&(r.loan_date_start=o.loan_date_range[0],r.loan_date_end=o.loan_date_range[1]),o.status&&(r.status=o.status);const l=await Re(r);E.value=l.data||[],y.total=l.total||0}catch{x.error("查询失败")}finally{S.value=!1}},le=()=>{o.customer_name="",o.business_type="",o.loan_account="",o.loan_date_range=[],o.status="",y.page=1,H()},oe=async()=>{var r,l,u;try{j.value=!0;const i={};o.customer_name&&(i.customer_name=o.customer_name),o.business_type&&(i.business_type=o.business_type),o.loan_account&&(i.loan_account=o.loan_account),o.loan_date_range&&o.loan_date_range.length===2&&(i.loan_date_start=o.loan_date_range[0],i.loan_date_end=o.loan_date_range[1]),o.status&&(i.status=o.status),console.log("导出参数:",i),i.limit=F.value,i.only_complete=T.value,console.log("导出参数(含limit和only_complete):",i);const h=await je(i);console.log("导出响应:",h);const g=window.URL.createObjectURL(h),f=document.createElement("a");f.href=g,f.download=`绿色金融任务导出_${Be().format("YYYYMMDD_HHmmss")}.csv`,f.style.display="none",f.target="_blank",f.rel="noopener noreferrer",document.body.appendChild(f),f.click(),document.body.removeChild(f),window.URL.revokeObjectURL(g),x.success("导出成功")}catch(i){if(console.error("导出失败:",i),console.error("错误详情:",i.response),((r=i.response)==null?void 0:r.data)instanceof Blob){const h=new FileReader;h.onload=()=>{try{const g=JSON.parse(h.result);console.error("错误信息:",g),console.error("错误详情数组:",g.detail),x.error(g.detail?JSON.stringify(g.detail):"导出失败")}catch{console.error("无法解析错误信息:",h.result),x.error("导出失败")}},h.readAsText(i.response.data)}else x.error(((u=(l=i.response)==null?void 0:l.data)==null?void 0:u.detail)||"导出失败")}finally{j.value=!1}},se=r=>{_.value={...r},N.value=!0},H=async()=>{L()};return ve(()=>{H()}),(r,l)=>{const u=c("el-icon"),i=c("el-tag"),h=c("el-input-number"),g=c("el-checkbox"),f=c("el-button"),U=c("el-input"),v=c("el-form-item"),C=c("el-col"),V=c("el-option"),I=c("el-select"),ne=c("el-date-picker"),re=c("el-row"),de=c("el-form"),ie=c("el-collapse-transition"),p=c("el-table-column"),Y=c("el-table"),ue=c("el-pagination"),J=c("el-card"),b=c("el-descriptions-item"),ce=c("el-descriptions"),$=c("el-divider"),Q=c("el-empty"),_e=c("el-timeline-item"),pe=c("el-timeline"),me=c("el-dialog"),fe=be("loading");return w(),D("div",Fe,[e(J,{shadow:"never"},{header:t(()=>[d("div",Te,[d("div",Ne,[e(u,{class:"header-icon",color:"#667eea"},{default:t(()=>[e(m(q))]),_:1}),l[10]||(l[10]=d("span",{class:"card-title"},"综合查询",-1)),e(i,{type:"info",size:"small"},{default:t(()=>[s(n(y.total)+" 条记录",1)]),_:1})]),d("div",Ye,[d("div",$e,[l[11]||(l[11]=d("span",{class:"export-label"},"导出数量:",-1)),e(h,{modelValue:F.value,"onUpdate:modelValue":l[0]||(l[0]=a=>F.value=a),min:1,max:1e5,step:1e3,placeholder:"导出数量",class:"export-input",size:"default","controls-position":"right"},null,8,["modelValue"]),l[12]||(l[12]=d("span",{class:"export-suffix"},"条",-1))]),e(g,{modelValue:T.value,"onUpdate:modelValue":l[1]||(l[1]=a=>T.value=a),class:"export-checkbox"},{default:t(()=>[...l[13]||(l[13]=[s(" 只导出有完整数据的记录 ",-1)])]),_:1},8,["modelValue"]),e(f,{type:"success",onClick:oe,loading:j.value,class:"export-button"},{default:t(()=>[e(u,null,{default:t(()=>[e(m(W))]),_:1}),l[14]||(l[14]=s(" 导出数据 ",-1))]),_:1},8,["loading"])])])]),default:t(()=>[d("div",Ae,[e(ie,null,{default:t(()=>[P(d("div",null,[e(de,{inline:!0,model:o,class:"search-form"},{default:t(()=>[e(re,{gutter:28},{default:t(()=>[e(C,{xs:24,sm:12,md:8,lg:5,xl:4},{default:t(()=>[e(v,{label:"客户名称"},{default:t(()=>[e(U,{modelValue:o.customer_name,"onUpdate:modelValue":l[2]||(l[2]=a=>o.customer_name=a),placeholder:"请输入客户名称",clearable:"",class:"search-input"},{prefix:t(()=>[e(u,null,{default:t(()=>[e(m(Z))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(C,{xs:24,sm:12,md:8,lg:5,xl:4},{default:t(()=>[e(v,{label:"业务品种"},{default:t(()=>[e(I,{modelValue:o.business_type,"onUpdate:modelValue":l[3]||(l[3]=a=>o.business_type=a),placeholder:"请选择业务品种",clearable:"",class:"search-input"},{default:t(()=>[e(V,{label:"一般性固定资产贷款",value:"一般性固定资产贷款"}),e(V,{label:"法人账户透支",value:"法人账户透支"}),e(V,{label:"流动资金贷款",value:"流动资金贷款"})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(C,{xs:24,sm:12,md:8,lg:5,xl:4},{default:t(()=>[e(v,{label:"贷款账号"},{default:t(()=>[e(U,{modelValue:o.loan_account,"onUpdate:modelValue":l[4]||(l[4]=a=>o.loan_account=a),placeholder:"请输入贷款账号",clearable:"",class:"search-input"},{prefix:t(()=>[e(u,null,{default:t(()=>[e(m(he))]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e(C,{xs:24,sm:12,md:8,lg:5,xl:4},{default:t(()=>[e(v,{label:"放款日期"},{default:t(()=>[e(ne,{modelValue:o.loan_date_range,"onUpdate:modelValue":l[5]||(l[5]=a=>o.loan_date_range=a),type:"daterange","range-separator":"至","start-placeholder":"开始日期","end-placeholder":"结束日期","value-format":"YYYY-MM-DD",clearable:"",class:"search-input"},null,8,["modelValue"])]),_:1})]),_:1}),e(C,{xs:24,sm:12,md:8,lg:4,xl:4},{default:t(()=>[e(v,{label:"状态"},{default:t(()=>[e(I,{modelValue:o.status,"onUpdate:modelValue":l[6]||(l[6]=a=>o.status=a),placeholder:"请选择状态",clearable:"",class:"search-input"},{default:t(()=>[e(V,{label:"待处理",value:"待处理"}),e(V,{label:"审核中",value:"审核中"}),e(V,{label:"已办结",value:"已办结"}),e(V,{label:"已撤回",value:"已撤回"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])],512),[[ye,z.value]])]),_:1}),d("div",Ee,[d("div",Oe,[e(f,{type:"primary",onClick:L,loading:S.value,size:"default"},{default:t(()=>[e(u,null,{default:t(()=>[e(m(q))]),_:1}),l[15]||(l[15]=s(" 查询 ",-1))]),_:1},8,["loading"]),e(f,{onClick:le,size:"default"},{default:t(()=>[e(u,null,{default:t(()=>[e(m(we))]),_:1}),l[16]||(l[16]=s(" 重置 ",-1))]),_:1}),e(f,{text:"",type:"primary",onClick:X,class:"toggle-button"},{default:t(()=>[e(u,null,{default:t(()=>[(w(),M(ke(z.value?"ArrowUp":"ArrowDown")))]),_:1}),s(" "+n(z.value?"收起查询":"展开查询"),1)]),_:1})])])]),P((w(),M(Y,{data:E.value,stripe:"","show-header":"",style:{width:"100%"},class:"modern-table"},{default:t(()=>[e(p,{type:"index",label:"序号",width:"80",align:"center"},{default:t(({$index:a})=>[d("div",He,n(a+1),1)]),_:1}),e(p,{prop:"customer_name",label:"客户名称","min-width":"150","show-overflow-tooltip":""},{default:t(({row:a})=>[d("div",Ie,[e(u,null,{default:t(()=>[e(m(Z))]),_:1}),s(" "+n(a.customer_name),1)])]),_:1}),e(p,{prop:"business_type",label:"业务品种",width:"150"},{default:t(({row:a})=>[e(i,{type:"primary",effect:"plain"},{default:t(()=>[s(n(a.business_type),1)]),_:2},1024)]),_:1}),e(p,{prop:"loan_account",label:"贷款账号",width:"150"}),e(p,{prop:"loan_amount",label:"放款金额(元)",width:"140",align:"right"},{default:t(({row:a})=>[d("div",Je,n(O(a.loan_amount)),1)]),_:1}),e(p,{prop:"loan_date",label:"放款日期",width:"120",align:"center"},{default:t(({row:a})=>[d("div",Qe,n(a.loan_date),1)]),_:1}),e(p,{prop:"status",label:"状态",width:"100",align:"center"},{default:t(({row:a})=>[e(i,{type:B(a.status),effect:"plain"},{default:t(()=>[s(n(a.status),1)]),_:2},1032,["type"])]),_:1}),e(p,{prop:"assignee_name",label:"发起人",width:"120"},{default:t(({row:a})=>[d("div",Ge,[e(u,null,{default:t(()=>[e(m(R))]),_:1}),s(" "+n(a.assignee_name),1)])]),_:1}),e(p,{prop:"created_at",label:"创建时间",width:"160",align:"center"},{default:t(({row:a})=>[d("div",Ke,n(a.created_at),1)]),_:1}),e(p,{label:"操作",width:"120",fixed:"right",align:"center"},{default:t(({row:a})=>[e(f,{type:"primary",link:"",onClick:G=>se(a),class:"action-button"},{default:t(()=>[e(u,null,{default:t(()=>[e(m(xe))]),_:1}),l[17]||(l[17]=s(" 查看 ",-1))]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[fe,S.value]]),d("div",Pe,[e(ue,{"current-page":y.page,"onUpdate:currentPage":l[7]||(l[7]=a=>y.page=a),"page-size":y.page_size,"onUpdate:pageSize":l[8]||(l[8]=a=>y.page_size=a),total:y.total,"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",onSizeChange:L,onCurrentChange:L},null,8,["current-page","page-size","total"])])]),_:1}),e(me,{modelValue:N.value,"onUpdate:modelValue":l[9]||(l[9]=a=>N.value=a),title:"任务详情",width:"900px","close-on-click-modal":!1,class:"detail-dialog"},{default:t(()=>[d("div",Ze,[e(ce,{column:2,border:"",class:"detail-descriptions"},{default:t(()=>[e(b,{label:"任务编号"},{default:t(()=>[s(n(_.value.task_id),1)]),_:1}),e(b,{label:"任务类型"},{default:t(()=>[s(n(_.value.task_key),1)]),_:1}),e(b,{label:"客户名称"},{default:t(()=>[s(n(_.value.customer_name),1)]),_:1}),e(b,{label:"业务品种"},{default:t(()=>[s(n(_.value.business_type),1)]),_:1}),e(b,{label:"贷款账号"},{default:t(()=>[s(n(_.value.loan_account),1)]),_:1}),e(b,{label:"放款金额"},{default:t(()=>[s(n(O(_.value.loan_amount)),1)]),_:1}),e(b,{label:"放款日期"},{default:t(()=>[s(n(_.value.loan_date),1)]),_:1}),e(b,{label:"绿色金融支持项目目录"},{default:t(()=>[s(n(_.value.green_project_category),1)]),_:1}),e(b,{label:"状态"},{default:t(()=>[e(i,{type:B(_.value.status)},{default:t(()=>[s(n(_.value.status),1)]),_:1},8,["type"])]),_:1}),e(b,{label:"发起人"},{default:t(()=>[s(n(_.value.assignee_name),1)]),_:1}),e(b,{label:"创建时间"},{default:t(()=>[s(n(_.value.created_at),1)]),_:1}),e(b,{label:"完成时间"},{default:t(()=>[s(n(_.value.completed_at||"-"),1)]),_:1})]),_:1}),e($,{"content-position":"left"},{default:t(()=>[d("span",qe,[e(u,null,{default:t(()=>[e(m(Ve))]),_:1}),l[18]||(l[18]=s(" 审批记录 ",-1))])]),_:1}),e(Y,{data:_.value.workflow_history||[],stripe:"",size:"small",class:"history-table"},{default:t(()=>[e(p,{prop:"node_name",label:"审批节点",width:"150"}),e(p,{prop:"approver_name",label:"审批人",width:"120"},{default:t(({row:a})=>[d("div",We,[e(u,null,{default:t(()=>[e(m(R))]),_:1}),s(" "+n(a.approver_name),1)])]),_:1}),e(p,{prop:"status",label:"状态",width:"100",align:"center"},{default:t(({row:a})=>[e(i,{type:B(a.status),size:"small",effect:"plain"},{default:t(()=>[s(n(a.status),1)]),_:2},1032,["type"])]),_:1}),e(p,{prop:"comment",label:"意见","min-width":"200","show-overflow-tooltip":""}),e(p,{prop:"created_at",label:"处理时间",width:"160",align:"center"})]),_:1},8,["data"]),e($,{"content-position":"left"},{default:t(()=>[d("span",Xe,[e(u,null,{default:t(()=>[e(m(ze))]),_:1}),l[19]||(l[19]=s(" 附件列表 ",-1))])]),_:1}),_.value.attachments&&_.value.attachments.length>0?(w(),D("div",et,[e(Y,{data:_.value.attachments,stripe:"",size:"small",class:"attachment-table"},{default:t(()=>[e(p,{prop:"task_name",label:"所属节点",width:"150"}),e(p,{prop:"uploader_name",label:"上传人",width:"120"},{default:t(({row:a})=>[d("div",tt,[e(u,null,{default:t(()=>[e(m(R))]),_:1}),s(" "+n(a.uploader_name),1)])]),_:1}),e(p,{prop:"original_filename",label:"附件名称","min-width":"200"},{default:t(({row:a})=>[e(f,{type:"primary",link:"",onClick:G=>te(a),class:"file-link"},{default:t(()=>[e(u,null,{default:t(()=>[e(m(W))]),_:1}),s(" "+n(a.original_filename),1)]),_:2},1032,["onClick"])]),_:1}),e(p,{prop:"file_size",label:"文件大小",width:"100",align:"right"},{default:t(({row:a})=>[s(n(ee(a.file_size)),1)]),_:1}),e(p,{prop:"created_at",label:"上传时间",width:"160",align:"center"})]),_:1},8,["data"])])):(w(),M(Q,{key:1,description:"暂无附件","image-size":60})),e($,{"content-position":"left"},{default:t(()=>[d("span",at,[e(u,null,{default:t(()=>[e(m(Ue))]),_:1}),l[20]||(l[20]=s(" 绿色分类变动轨迹 ",-1))])]),_:1}),e(pe,{class:"trace-timeline"},{default:t(()=>[(w(!0),D(Ce,null,De(_.value.workflow_history||[],(a,G)=>(w(),M(_e,{key:a.id,timestamp:a.created_at,placement:"top",type:ae(a.status)},{default:t(()=>[e(J,{shadow:"never",class:"trace-card"},{default:t(()=>[d("div",lt,[d("span",ot,n(a.node_name),1),e(i,{size:"small",type:B(a.status),effect:"plain"},{default:t(()=>[s(n(a.status),1)]),_:2},1032,["type"])]),d("div",st,[d("span",nt,[e(u,null,{default:t(()=>[e(m(R))]),_:1}),s(" 办理人: "+n(a.approver_name),1)])]),a.comment?(w(),D("div",rt,[d("span",dt,[e(u,null,{default:t(()=>[e(m(Me))]),_:1}),s(" 意见: "+n(a.comment),1)])])):A("",!0),a.formatted_category?(w(),D("div",it,[d("div",ut,[e(u,null,{default:t(()=>[e(m(Se))]),_:1}),l[21]||(l[21]=s(" 绿色金融支持项目目录: ",-1))]),d("div",ct,n(a.formatted_category),1)])):A("",!0)]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1}),!_.value.workflow_history||_.value.workflow_history.length===0?(w(),M(Q,{key:2,description:"暂无分类变动轨迹"})):A("",!0)])]),_:1},8,["modelValue"])])}}},bt=ge(_t,[["__scopeId","data-v-10eb7f40"]]);export{bt as default};
