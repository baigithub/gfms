import{_ as Le,u as Re,p as Oe,o as d,c as v,b as s,w as l,E as g,r as f,m as C,D,q as qe,d as He,Q as Ne,i as c,t as u,a as r,e as se,R as Ge,F as B,y as S,N as Pe,x as k,S as Ie,s as x,I as We,T as O,G as Qe,j as Je}from"./index-DDrUN6p6.js";import{a as Xe,b as Ze,c as G,u as et,s as tt,w as at,d as lt,r as st}from"./green_finance-B4o63B-q.js";import{u as ot}from"./tabs-DyOH422c.js";import"./index-B2NntqTq.js";import"./index-D5GkNzM3.js";const nt={class:"task-detail-page"},rt={class:"card-header"},it={class:"card-title"},ut={class:"upload-section"},dt={key:0,class:"uploaded-files"},ct={class:"files-title"},_t={class:"files-list"},pt={class:"file-name"},mt={class:"file-size"},ft={class:"opinion-section"},vt={class:"timeline-content"},gt={class:"timeline-header"},yt={class:"timeline-title"},ht={class:"timeline-detail"},kt={key:0},wt={key:0,class:"timeline-result"},bt={key:1,class:"timeline-comment"},Ct={key:2,class:"timeline-reason"},xt={class:"flow-chart"},Tt={key:0,class:"flow-info"},$t={class:"flow-item-title"},Mt={class:"flow-item-info"},Dt={key:0},Vt={key:1},jt={key:2,class:"flow-item-duration"},zt={class:"category-trace"},Bt={class:"trace-header"},St={class:"trace-title"},Ut={class:"trace-detail"},Et={key:0},Ft={key:0,class:"trace-category"},Kt={class:"category-value"},Yt={key:1,class:"trace-category-empty"},At={class:"attachments-section"},Lt={class:"page-actions"},Rt={class:"dialog-footer"},Ot={class:"dialog-footer"},qt={__name:"TaskDetail",setup(Ht){const U=qe(),j=He(),oe=Re(),P=ot(),M=D(()=>U.params.id),m=C({}),p=C([]),I=C("business"),ne=C(!1),w=C([]),q=C([]),re={value:"value",label:"label",children:"children",emitPath:!0,checkStrictly:!1},R=C(""),V=C([]),ie=D(()=>`http://localhost:8000/api/files/upload?task_id=${M.value}`),ue=D(()=>({Authorization:`Bearer ${oe.token}`})),E=C(!1),F=C(!1),T=Je({return_to_node:"",comment:""}),de=D(()=>{if(!p.value||p.value.length===0)return!1;const t=p.value.find(o=>o.status==="待处理");return!(!t||t.task_key==="manager_identification")}),ce=D(()=>{if(!p.value||p.value.length===0)return!1;const t=p.value.find(o=>o.status==="待处理");return!(!t||t.task_key==="final_review")}),_e=D(()=>{if(!p.value||p.value.length===0)return[];const t=p.value.find(n=>n.status==="待处理");if(!t)return[];const e=t.task_key;return{branch_review:[{value:"manager_identification",label:"客户经理认定"}],first_approval:[{value:"manager_identification",label:"客户经理认定"},{value:"branch_review",label:"二级分行绿色金融管理岗"}],final_review:[{value:"manager_identification",label:"客户经理认定"},{value:"branch_review",label:"二级分行绿色金融管理岗"},{value:"first_approval",label:"一级分行绿色金融管理岗"}]}[e]||[]}),pe=D(()=>{if(!p.value||p.value.length===0)return 0;const t=p.value[p.value.length-1];if(t.approval_result==="同意"){if(t.task_key==="manager_identification")return 1;if(t.task_key==="branch_review")return 2;if(t.task_key==="final_approval")return 4}return 1}),me=D(()=>{if(!p.value||p.value.length===0)return[{title:"开始",description:"客户经理发起认定",status:"wait"},{title:"客户经理认定",description:"填写认定信息",status:"process"},{title:"分行审核",description:"绿色金融管理部门审核",status:"wait"},{title:"最终审批",description:"一级分行最终审批",status:"wait"},{title:"结束",description:"流程完成",status:"wait"}];const t=[{title:"开始",description:"客户经理发起认定",status:"finish"}];return p.value.forEach((e,o)=>{e.status==="已完成"?t.push({title:e.task_name,description:"已完成",status:"finish"}):e.status==="待处理"&&t.push({title:e.task_name,description:"办理中",status:"process"})}),t.push({title:"结束",description:"流程完成",status:"wait"}),t}),fe=t=>t?Number(t).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}):"0.00",W=t=>t?O(t).format("YYYY-MM-DD"):"-",K=t=>t?O(t).format("YYYY-MM-DD HH:mm:ss"):"-",ve=(t,e)=>{if(!t||!e)return"-";const o=O(t),i=O(e).diff(o,"second");if(i<60)return`${i}秒`;if(i<3600){const _=Math.floor(i/60),y=i%60;return y>0?`${_}分${y}秒`:`${_}分钟`}else if(i<86400){const _=Math.floor(i/3600),y=Math.floor(i%3600/60);return y>0?`${_}小时${y}分`:`${_}小时`}else{const _=Math.floor(i/86400),y=Math.floor(i%86400/3600);return y>0?`${_}天${y}小时`:`${_}天`}},Q=t=>({待处理:"warning",已完成:"success",已撤回:"info",已退回:"warning",暂存:"info"})[t]||"info",H=async()=>{try{const[t,e]=await Promise.all([Xe(M.value),Ze(M.value)]);if(m.value=t,p.value=e,console.log("任务详情数据:",t),console.log("附件数据:",t.attachments),console.log("流程跟踪数据:",e),e.forEach(o=>{console.log(`任务${o.id}:`,{task_name:o.task_name,status:o.status,assignee_name:o.assignee_name,assignee_username:o.assignee_username,formatted_category:o.formatted_category,completed_at:o.completed_at})}),t.project_category_small||t.project_category_medium||t.project_category_large){await J();const n=((i,_=null,y=null)=>{const h=q.value.find($=>$.label.includes(i));if(!h)return null;const Y=[h.value];if(_&&h.children){const $=h.children.find(b=>b.label.includes(_));if($&&(Y.push($.value),y&&$.children)){const b=$.children.find(A=>A.label.includes(y));b&&Y.push(b.value)}}return Y})(t.project_category_large,t.project_category_medium,t.project_category_small);n&&(w.value=n)}}catch{g.error("获取任务详情失败")}},J=async()=>{try{const t=await G();q.value=ge(t)}catch(t){console.error("加载绿色项目目录失败:",t)}},ge=t=>{const e=new Map;t.forEach(n=>{e.has(n.large_code)||e.set(n.large_code,{value:n.large_code,label:`${n.large_code} ${n.large_name}`,children:[]})});const o=new Map;return t.forEach(n=>{const i=e.get(n.large_code);if(i){const _=`${n.large_code}-${n.medium_code}`;if(!o.has(_)){const y={value:n.medium_code,label:`${n.medium_code} ${n.medium_name}`,children:[]};i.children.push(y),o.set(_,y)}}}),t.forEach(n=>{if(n.small_code){const i=`${n.large_code}-${n.medium_code}`,_=o.get(i);_&&_.children.push({value:n.small_code,label:`${n.small_code} ${n.small_name}`})}}),Array.from(e.values())},ye=async t=>{if(!(!t||t.length===0))try{const e={project_category_large:"",project_category_medium:"",project_category_small:""},o=await G(),n=o.find(i=>i.large_code===t[0]);if(n&&(e.project_category_large=n.large_name),t[1]){const i=o.find(_=>_.large_code===t[0]&&_.medium_code===t[1]);i&&(e.project_category_medium=i.medium_name)}if(t[2]){const i=o.find(_=>_.large_code===t[0]&&_.medium_code===t[1]&&_.small_code===t[2]);i&&(e.project_category_small=i.small_name)}await et(M.value,e),g.success("绿色金融支持项目目录已更新"),await H()}catch(e){console.error("更新分类失败:",e),g.error("更新绿色金融支持项目目录失败")}},he=()=>{U.query.from==="pending"?j.push("/green-identify/pending"):j.back()},ke=()=>{E.value=!0},we=async()=>{try{await lt(M.value,{approval_result:"同意",comment:R.value||"",reason:""}),g.success("任务已完成"),E.value=!1,P.removeTab(U.path),setTimeout(()=>{j.push({path:"/green-identify/pending",query:{t:Date.now()}})},500)}catch{g.error("任务完成失败")}},be=async()=>{try{await Qe.confirm("确定要撤回此任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await at(M.value),g.success("任务已撤回"),setTimeout(()=>{U.query.from==="pending"?j.push("/green-identify/pending"):j.back()},1e3)}catch(t){t!=="cancel"&&g.error("任务撤回失败")}},Ce=async()=>{try{const t={project_category_large:m.value.project_category_large,project_category_medium:m.value.project_category_medium,project_category_small:m.value.project_category_small,comment:R.value};if(w.value&&w.value.length>0)try{const e=await G(),o=e.find(n=>n.large_code===w.value[0]);if(o&&(t.project_category_large=o.large_name),w.value[1]){const n=e.find(i=>i.large_code===w.value[0]&&i.medium_code===w.value[1]);n&&(t.project_category_medium=n.medium_name)}if(w.value[2]){const n=e.find(i=>i.large_code===w.value[0]&&i.medium_code===w.value[1]&&i.small_code===w.value[2]);n&&(t.project_category_small=n.small_name)}}catch(e){console.error("获取分类信息失败:",e)}await tt(M.value,t),g.success("任务已保存"),await H()}catch{g.error("任务保存失败")}},xe=()=>{T.return_to_node="",T.comment="",F.value=!0},Te=async()=>{if(!T.return_to_node){g.warning("请选择退回节点");return}try{await st(M.value,{return_to_node:T.return_to_node,comment:T.comment}),g.success("任务已退回"),F.value=!1,P.removeTab(U.path),setTimeout(()=>{j.push({path:"/green-identify/pending",query:{t:Date.now()}})},500)}catch{g.error("任务退回失败")}},$e=(t,e)=>{t.code===0||t.success?g.success("文件上传成功"):(g.error(t.message||"文件上传失败"),V.value=V.value.filter(o=>o.uid!==e.uid))},X=t=>{g.success("文件已移除")},Me=t=>{t.url?window.open(t.url,"_blank"):t.response&&t.response.url?window.open(t.response.url,"_blank"):g.warning("无法预览该文件")},De=t=>{const o=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","image/jpeg","image/png"].includes(t.type),n=t.size/1024/1024<10;return o?n?!0:(g.error("文件大小不能超过 10MB!"),!1):(g.error("只支持 pdf、doc、docx、xls、xlsx、jpg、png 格式的文件!"),!1)},Ve=(t,e)=>{},Z=t=>{if(!t)return"0 B";const e=1024,o=["B","KB","MB","GB"],n=Math.floor(Math.log(t)/Math.log(e));return(t/Math.pow(e,n)).toFixed(2)+" "+o[n]},je=t=>t==="已完成"?"success":t==="待处理"?"primary":t==="已撤回"?"info":"warning",ze=t=>{const o=`http://localhost:8000${t.download_url}`;window.open(o,"_blank")};return Oe(()=>{H(),J()}),(t,e)=>{const o=f("el-descriptions-item"),n=f("el-cascader"),i=f("el-tag"),_=f("el-descriptions"),y=f("el-icon"),h=f("el-button"),Y=f("el-upload"),$=f("el-input"),b=f("el-tab-pane"),A=f("el-card"),ee=f("el-timeline-item"),te=f("el-timeline"),N=f("el-empty"),Be=f("el-step"),Se=f("el-steps"),L=f("el-table-column"),Ue=f("el-table"),Ee=f("el-tabs"),ae=f("el-dialog"),Fe=f("el-option"),Ke=f("el-select"),le=f("el-form-item"),Ye=f("el-form"),Ae=Ne("loading");return d(),v("div",nt,[s(A,{shadow:"hover"},{header:l(()=>[r("div",rt,[r("span",it,"任务详情 - "+u(m.value.customer_name),1)])]),default:l(()=>[s(Ee,{modelValue:I.value,"onUpdate:modelValue":e[3]||(e[3]=a=>I.value=a),type:"border-card"},{default:l(()=>[s(b,{label:"业务信息",name:"business"},{default:l(()=>[s(_,{column:2,border:""},{default:l(()=>[s(o,{label:"贷款编号"},{default:l(()=>[c(u(m.value.loan_code),1)]),_:1}),s(o,{label:"客户名称"},{default:l(()=>[c(u(m.value.customer_name),1)]),_:1}),s(o,{label:"业务品种"},{default:l(()=>[c(u(m.value.business_type),1)]),_:1}),s(o,{label:"贷款账号"},{default:l(()=>[c(u(m.value.loan_account),1)]),_:1}),s(o,{label:"放款金额"},{default:l(()=>[c(u(fe(m.value.loan_amount)),1)]),_:1}),s(o,{label:"放款日期"},{default:l(()=>[c(u(W(m.value.disbursement_date)),1)]),_:1}),s(o,{label:"绿色金融支持项目目录",span:2},{default:l(()=>[s(n,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=a=>w.value=a),options:q.value,props:re,placeholder:"请选择绿色金融支持项目目录",clearable:"",filterable:"",onChange:ye,style:{width:"100%"}},null,8,["modelValue","options"])]),_:1}),s(o,{label:"任务办理截止日期"},{default:l(()=>[c(u(m.value.deadline?W(m.value.deadline):"-"),1)]),_:1}),s(o,{label:"状态"},{default:l(()=>[s(i,{type:Q(m.value.status),size:"small"},{default:l(()=>[c(u(m.value.status),1)]),_:1},8,["type"])]),_:1}),s(o,{label:"发起人"},{default:l(()=>[c(u(m.value.initiator_name),1)]),_:1}),s(o,{label:"发起时间"},{default:l(()=>[c(u(K(m.value.started_at)),1)]),_:1}),s(o,{label:"完成时间",span:2},{default:l(()=>[c(u(m.value.completed_at?K(m.value.completed_at):"-"),1)]),_:1}),s(o,{label:"机构",span:2},{default:l(()=>[c(u(m.value.org_name||"-"),1)]),_:1})]),_:1}),r("div",ut,[e[13]||(e[13]=r("div",{class:"section-title"},"材料上传",-1)),s(Y,{"file-list":V.value,"onUpdate:fileList":e[1]||(e[1]=a=>V.value=a),action:ie.value,headers:ue.value,"on-success":$e,"on-remove":X,"on-preview":Me,"on-change":Ve,limit:10,"before-upload":De,"auto-upload":!0,multiple:"","list-type":"text"},{tip:l(()=>[...e[11]||(e[11]=[r("div",{class:"el-upload__tip"}," 支持 jpg、png、pdf、doc、docx、xls、xlsx 格式，单个文件不超过10MB，最多上传10个文件 ",-1)])]),default:l(()=>[s(h,{type:"primary",size:"small"},{default:l(()=>[s(y,null,{default:l(()=>[s(se(Ge))]),_:1}),e[10]||(e[10]=c(" 选择文件 ",-1))]),_:1})]),_:1},8,["file-list","action","headers"]),V.value.length>0?(d(),v("div",dt,[r("div",ct,"已上传文件 ("+u(V.value.length)+")",1),r("div",_t,[(d(!0),v(B,null,S(V.value,(a,z)=>(d(),v("div",{key:z,class:"file-item"},[s(y,null,{default:l(()=>[s(se(Pe))]),_:1}),r("span",pt,u(a.name),1),r("span",mt,u(Z(a.size)),1),s(h,{type:"danger",link:"",size:"small",onClick:Nt=>X(a)},{default:l(()=>[...e[12]||(e[12]=[c(" 删除 ",-1)])]),_:1},8,["onClick"])]))),128))])])):k("",!0)]),r("div",ft,[e[14]||(e[14]=r("div",{class:"section-title"},"办理意见",-1)),s($,{modelValue:R.value,"onUpdate:modelValue":e[2]||(e[2]=a=>R.value=a),type:"textarea",rows:4,placeholder:"请输入办理意见",maxlength:"500","show-word-limit":""},null,8,["modelValue"])])]),_:1}),s(b,{label:"审批记录",name:"approval"},{default:l(()=>[Ie((d(),v("div",null,[p.value.length>0?(d(),x(te,{key:0},{default:l(()=>[(d(!0),v(B,null,S(p.value,a=>(d(),x(ee,{key:a.id,timestamp:K(a.completed_at||a.started_at),placement:"top"},{default:l(()=>[s(A,null,{default:l(()=>[r("div",vt,[r("div",gt,[r("span",yt,u(a.task_name),1),s(i,{type:Q(a.status),size:"small"},{default:l(()=>[c(u(a.status),1)]),_:2},1032,["type"])]),r("div",ht,[r("span",null,"审批人: "+u(a.assignee_name),1),a.assignee_username?(d(),v("span",kt,"账号: "+u(a.assignee_username),1)):k("",!0),r("span",null,"岗位: "+u(a.position_name),1)]),a.approval_result?(d(),v("div",wt,[e[15]||(e[15]=r("span",null,"审批结果: ",-1)),r("span",{class:We(a.approval_result==="同意"?"result-agree":"result-disagree")},u(a.approval_result),3)])):k("",!0),a.comment?(d(),v("div",bt,[r("span",null,"意见: "+u(a.comment),1)])):k("",!0),a.reason?(d(),v("div",Ct,[r("span",null,"原因: "+u(a.reason),1)])):k("",!0)])]),_:2},1024)]),_:2},1032,["timestamp"]))),128))]),_:1})):(d(),x(N,{key:1,description:"暂无审批记录"}))])),[[Ae,ne.value]])]),_:1}),s(b,{label:"流程跟踪",name:"flow"},{default:l(()=>[r("div",xt,[s(Se,{active:pe.value,"align-center":"","finish-status":"success"},{default:l(()=>[(d(!0),v(B,null,S(me.value,(a,z)=>(d(),x(Be,{key:z,title:a.title,description:a.description,status:a.status},null,8,["title","description","status"]))),128))]),_:1},8,["active"]),p.value.length>0?(d(),v("div",Tt,[(d(!0),v(B,null,S(p.value,(a,z)=>(d(),v("div",{key:a.id,class:"flow-item"},[r("div",$t,u(a.task_name),1),r("div",Mt,[a.assignee_name?(d(),v("span",Dt,"办理人: "+u(a.assignee_name),1)):k("",!0),a.completed_at?(d(),v("span",Vt," | 完成时间: "+u(K(a.completed_at)),1)):k("",!0),a.started_at&&a.completed_at?(d(),v("span",jt," | 耗时: "+u(ve(a.started_at,a.completed_at)),1)):k("",!0)])]))),128))])):k("",!0)])]),_:1}),s(b,{label:"绿色分类变动轨迹",name:"category-trace"},{default:l(()=>[r("div",zt,[s(te,null,{default:l(()=>[(d(!0),v(B,null,S(p.value,(a,z)=>(d(),x(ee,{key:a.id,timestamp:K(a.completed_at||a.started_at),placement:"top",type:je(a.status)},{default:l(()=>[s(A,{shadow:"hover",class:"trace-card"},{default:l(()=>[r("div",Bt,[r("span",St,u(a.task_name),1),s(i,{size:"small"},{default:l(()=>[c(u(a.status),1)]),_:2},1024)]),r("div",Ut,[r("span",null,"办理人: "+u(a.assignee_name),1),a.assignee_username?(d(),v("span",Et,"账号: "+u(a.assignee_username),1)):k("",!0)]),a.formatted_category?(d(),v("div",Ft,[e[16]||(e[16]=r("div",{class:"category-label"},"绿色金融支持项目目录:",-1)),r("div",Kt,u(a.formatted_category),1)])):(d(),v("div",Yt,[...e[17]||(e[17]=[r("span",null,"暂无分类信息",-1)])]))]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1}),!p.value||p.value.length===0?(d(),x(N,{key:0,description:"暂无分类变动轨迹"})):k("",!0)])]),_:1}),s(b,{label:"附件列表",name:"attachments"},{default:l(()=>[r("div",At,[s(Ue,{data:m.value.attachments||[],stripe:"",size:"small"},{default:l(()=>[s(L,{prop:"task_name",label:"所属节点",width:"150"}),s(L,{prop:"uploader_name",label:"上传人",width:"120"}),s(L,{prop:"original_filename",label:"附件名称","min-width":"200"},{default:l(({row:a})=>[s(h,{type:"primary",link:"",size:"small",onClick:z=>ze(a)},{default:l(()=>[c(u(a.original_filename),1)]),_:2},1032,["onClick"])]),_:1}),s(L,{prop:"file_size",label:"文件大小",width:"100"},{default:l(({row:a})=>[c(u(Z(a.file_size)),1)]),_:1}),s(L,{prop:"created_at",label:"上传时间",width:"160"})]),_:1},8,["data"]),!m.value.attachments||m.value.attachments.length===0?(d(),x(N,{key:0,description:"暂无附件","image-size":60})):k("",!0)])]),_:1})]),_:1},8,["modelValue"]),r("div",Lt,[s(h,{onClick:he},{default:l(()=>[...e[18]||(e[18]=[c("关闭",-1)])]),_:1}),s(h,{type:"success",onClick:Ce},{default:l(()=>[...e[19]||(e[19]=[c("保存",-1)])]),_:1}),s(h,{type:"primary",onClick:ke},{default:l(()=>[...e[20]||(e[20]=[c("审批",-1)])]),_:1}),de.value?(d(),x(h,{key:0,type:"warning",onClick:xe},{default:l(()=>[...e[21]||(e[21]=[c("退回",-1)])]),_:1})):k("",!0),ce.value?(d(),x(h,{key:1,onClick:be},{default:l(()=>[...e[22]||(e[22]=[c("撤回",-1)])]),_:1})):k("",!0)])]),_:1}),s(ae,{modelValue:E.value,"onUpdate:modelValue":e[5]||(e[5]=a=>E.value=a),title:"任务审批",width:"400px","close-on-click-modal":!1},{footer:l(()=>[r("div",Rt,[s(h,{onClick:e[4]||(e[4]=a=>E.value=!1)},{default:l(()=>[...e[23]||(e[23]=[c("取消",-1)])]),_:1}),s(h,{type:"primary",onClick:we},{default:l(()=>[...e[24]||(e[24]=[c("确定",-1)])]),_:1})])]),default:l(()=>[e[25]||(e[25]=r("div",{class:"approval-message"},"您是否确认提交？",-1))]),_:1},8,["modelValue"]),s(ae,{modelValue:F.value,"onUpdate:modelValue":e[9]||(e[9]=a=>F.value=a),title:"任务退回",width:"500px","close-on-click-modal":!1},{footer:l(()=>[r("div",Ot,[s(h,{onClick:e[8]||(e[8]=a=>F.value=!1)},{default:l(()=>[...e[26]||(e[26]=[c("取消",-1)])]),_:1}),s(h,{type:"primary",onClick:Te},{default:l(()=>[...e[27]||(e[27]=[c("确定",-1)])]),_:1})])]),default:l(()=>[s(Ye,{"label-width":"100px"},{default:l(()=>[s(le,{label:"退回到"},{default:l(()=>[s(Ke,{modelValue:T.return_to_node,"onUpdate:modelValue":e[6]||(e[6]=a=>T.return_to_node=a),placeholder:"请选择退回节点",style:{width:"100%"}},{default:l(()=>[(d(!0),v(B,null,S(_e.value,a=>(d(),x(Fe,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),s(le,{label:"退回意见"},{default:l(()=>[s($,{modelValue:T.comment,"onUpdate:modelValue":e[7]||(e[7]=a=>T.comment=a),type:"textarea",rows:4,placeholder:"请输入退回意见",maxlength:"500","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1},8,["modelValue"])])}}},Jt=Le(qt,[["__scopeId","data-v-8eaae8f2"]]);export{Jt as default};
