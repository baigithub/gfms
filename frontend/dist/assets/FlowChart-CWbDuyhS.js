import{_ as G,s as Q,r as g,o as u,c as h,a as c,F as x,y as F,O as b,i as A,w,b as y,e as D,Y as X,a4 as Z,t as k,j as H,m as O,g as K,a7 as tt,a2 as et,J as I,p as V}from"./index-D4Rku7DI.js";const st={class:"flow-chart-container"},ot={class:"flow-chart"},nt={class:"flow-rows"},it=["data-code","data-status","onClick"],rt={class:"flow-node-icon"},at={key:2,class:"operation-count"},lt={class:"flow-node-title"},ct={key:0,class:"flow-node-info"},dt={class:"node-history-content"},ut={class:"history-header"},ft={class:"history-title"},_t={class:"history-detail"},ht={class:"detail-item"},pt={class:"detail-item"},wt={key:0,class:"history-result"},yt={key:1,class:"history-comment"},kt={key:2,class:"history-reason"},mt={class:"dialog-footer"},gt={__name:"FlowChart",props:{workflowHistory:{type:Array,default:()=>[]},processDefinitionId:{type:[Number,null],default:null}},setup($){const i=$,T=V(!1),B=V([]),v=V(null),z=()=>{if(i.workflowHistory&&i.workflowHistory.length>0&&i.processDefinitionId){const e=new Set,s={};i.workflowHistory.forEach(t=>{t.task_key&&t.task_name&&(e.add(t.task_key),s[t.task_key]=t.task_name)});const n=[{title:"开始",description:"客户经理发起认定",code:"start"}];return Array.from(e).sort((t,l)=>{const _=i.workflowHistory.find(f=>f.task_key===t),d=i.workflowHistory.find(f=>f.task_key===l);return((_==null?void 0:_.started_at)||0)-((d==null?void 0:d.started_at)||0)}).forEach(t=>{n.push({title:s[t]||t,description:s[t]||t,code:t})}),n.push({title:"结束",description:"流程完成",code:"end"}),n}else if(v.value&&v.value.nodes){const e=[{title:"开始",description:"客户经理发起认定",code:"start"}];return v.value.nodes.forEach(s=>{s.type==="task"&&e.push({title:s.name,description:s.name,code:s.task_key||s.name})}),e.push({title:"结束",description:"流程完成",code:"end"}),e}else return[{title:"开始",description:"客户经理发起认定",code:"start"},{title:"客户经理提交",description:"填写认定信息",code:"manager_identification"},{title:"二级分行认定",description:"二级分行绿色金融管理部门审核",code:"branch_review"},{title:"一级分行认定",description:"一级分行审批",code:"first_approval"},{title:"一级分行复核",description:"最终复核",code:"final_review"},{title:"结束",description:"流程完成",code:"end"}]},Y=async()=>{try{const e=localStorage.getItem("token"),s={"Content-Type":"application/json"};e&&(s.Authorization=`Bearer ${e}`);const n=await fetch("/api/workflow/definitions?name=绿色认定&status=active&page=1&page_size=1",{headers:s});if(!n.ok){console.warn("获取流程定义失败:",n.status,n.statusText);return}const r=await n.json();if(r&&r.length>0){const t=r[0];if(t.bpmn_xml){const _=new DOMParser().parseFromString(t.bpmn_xml,"text/xml"),d=[],f=_.getElementsByTagNameNS("*","userTask");console.log("找到userTask节点数量:",f.length);for(let o=0;o<f.length;o++){const p=f[o],a=p.getAttribute("name")||p.getAttribute("id"),m=p.getAttribute("id");console.log(`节点${o}: id=${m}, name=${a}`),d.push({id:m,name:a,type:"task",task_key:m})}v.value={id:t.id,version:t.version,name:t.name,nodes:d},console.log("获取到当前启用流程定义:",v.value)}}}catch(e){console.warn("获取当前启用流程定义失败:",e)}};Q(()=>{i.processDefinitionId||Y()});const M=I(()=>{if(!i.workflowHistory&&!i.processDefinitionId&&!v.value)return[];const e=z(),s=[];return e.forEach(n=>{var l,_;const r=(l=i.workflowHistory)==null?void 0:l.find(d=>d.task_key===n.code);let t="wait";if(n.code==="start")t="finish";else if(n.code==="end"){const d=s.filter(o=>{var p;return o.code!=="start"&&o.code!=="end"&&((p=i.workflowHistory)==null?void 0:p.some(a=>a.task_key===o.code))}),f=d.every(o=>o.status==="finish");t=d.length>0&&f?"finish":"wait"}else r&&(t=((_=i.workflowHistory)==null?void 0:_.filter(o=>o.task_key===n.code)).some(o=>o.status==="已完成")?"finish":"wait");s.push({title:n.title,description:n.description,code:n.code,status:t})}),s}),j=I(()=>{if(M.value.length===0)return[];const e=[];return e.push(M.value),e}),W=e=>e&&e.length>0&&e.every(s=>s.status==="finish"),P=(e,s)=>e.status==="finish"&&s.status==="finish"?"finished":"pending",N=e=>{if(!e||e==="start"||e==="end")return!1;const s=i.workflowHistory.filter(t=>t.task_key===e);if(s.length>0&&s.every(t=>t.status==="已撤回"))return!1;const n=s.filter(t=>t.status!=="已撤回").length,r=i.workflowHistory.filter(t=>t.status==="已撤回"&&C(e,t.task_key)).length;return n+r>1},R=e=>{if(!e||e==="start"||e==="end")return 0;const s=i.workflowHistory.filter(t=>t.task_key===e);if(s.length>0&&s.every(t=>t.status==="已撤回"))return 0;const n=s.filter(t=>t.status!=="已撤回").length,r=i.workflowHistory.filter(t=>t.status==="已撤回"&&C(e,t.task_key)).length;return n+r},C=(e,s)=>{const n=["manager_identification","branch_review","first_approval","final_review"],r=n.indexOf(e);return n.indexOf(s)===r+1},J=e=>{if(!e||e==="start"||e==="end")return!1;const s=i.workflowHistory.filter(t=>t.task_key===e);if(s.length>0&&s.every(t=>t.status==="已撤回"))return!1;const n=s.filter(t=>t.status!=="已撤回").length,r=i.workflowHistory.filter(t=>t.status==="已撤回"&&C(e,t.task_key)).length;return n===1&&s.filter(t=>t.status==="已完成").length===1&&r===0},S=e=>{if(!e||e==="start"||e==="end")return null;const s=i.workflowHistory.filter(t=>t.task_key===e);if(s.length>0&&s.every(t=>t.status==="已撤回")||i.workflowHistory.filter(t=>t.status==="已撤回"&&C(e,t.task_key)).length>0)return null;const r=s.filter(t=>t.status!=="已撤回");return r.length>0?r[0]:null},L=e=>{if(!N(e))return;const s=i.workflowHistory.filter(l=>l.task_key===e);if(s.length>0&&s.every(l=>l.status==="已撤回"))return;const n=s.filter(l=>l.status!=="已撤回"),r=i.workflowHistory.filter(l=>l.status==="已撤回"&&C(e,l.task_key)),t=[...n,...r].sort((l,_)=>{const d=new Date(l.started_at||l.completed_at).getTime(),f=new Date(_.started_at||_.completed_at).getTime();return d-f});B.value=t,T.value=!0},E=e=>e?et(e).format("YYYY-MM-DD HH:mm:ss"):"-",U=e=>e==="已完成"?"success":e==="待处理"?"primary":e==="已撤回"?"info":"warning",q=e=>({待处理:"warning",已完成:"success",已撤回:"info",已退回:"warning",暂存:"info"})[e]||"info";return(e,s)=>{const n=g("el-icon"),r=g("el-tag"),t=g("el-card"),l=g("el-timeline-item"),_=g("el-timeline"),d=g("el-button"),f=g("el-dialog");return u(),h("div",st,[c("div",ot,[c("div",nt,[(u(!0),h(x,null,F(j.value,(o,p)=>(u(),h("div",{key:p,class:b(["flow-row",{"row-all-finished":W(o)}])},[(u(!0),h(x,null,F(o,(a,m)=>(u(),h("div",{key:a.code||m,class:b(["flow-node",{"node-finished":a.status==="finish","node-clickable":N(a.code),"node-right-edge":p%2===1&&m===0,"node-last-in-row":m===o.length-1}]),"data-code":a.code,"data-status":a.status,onClick:vt=>L(a.code)},[c("div",rt,[a.status==="finish"?(u(),A(n,{key:0},{default:w(()=>[y(D(X))]),_:1})):(u(),A(n,{key:1},{default:w(()=>[y(D(Z))]),_:1})),N(a.code)?(u(),h("div",at,k(R(a.code)),1)):H("",!0)]),c("div",lt,k(a.title),1),J(a.code)?(u(),h("div",ct," 由 "+k(S(a.code).assignee_name)+" 于 "+k(E(S(a.code).completed_at||S(a.code).started_at))+" 办理完成 ",1)):H("",!0),m<o.length-1?(u(),h("div",{key:1,class:b(["connection-line",P(a,o[m+1])])},null,2)):H("",!0)],10,it))),128))],2))),128))])]),y(f,{modelValue:T.value,"onUpdate:modelValue":s[1]||(s[1]=o=>T.value=o),title:"节点操作历史",width:"700px",class:"node-history-dialog","close-on-click-modal":!1},{footer:w(()=>[c("div",mt,[y(d,{onClick:s[0]||(s[0]=o=>T.value=!1),size:"large"},{default:w(()=>[...s[6]||(s[6]=[O("关闭",-1)])]),_:1})])]),default:w(()=>[c("div",dt,[y(_,null,{default:w(()=>[(u(!0),h(x,null,F(B.value,(o,p)=>(u(),A(l,{key:o.id,timestamp:E(o.completed_at||o.started_at),placement:"top",type:U(o.status)},{default:w(()=>[y(t,{shadow:"hover",class:"history-card"},{default:w(()=>[c("div",ut,[c("span",ft,"第 "+k(p+1)+" 次操作",1),y(r,{type:q(o.status),size:"small",effect:"dark"},{default:w(()=>[O(k(o.status),1)]),_:2},1032,["type"])]),s[5]||(s[5]=O()),c("div",_t,[c("div",ht,[y(n,{class:"detail-icon"},{default:w(()=>[y(D(K))]),_:1}),c("span",null,"办理人: "+k(o.assignee_name),1)]),c("div",pt,[y(n,{class:"detail-icon"},{default:w(()=>[y(D(tt))]),_:1}),c("span",null,"岗位: "+k(o.position_name),1)])]),o.approval_result?(u(),h("div",wt,[s[2]||(s[2]=c("span",{class:"result-label"},"审批结果: ",-1)),c("span",{class:b(o.approval_result==="同意"?"result-agree":"result-disagree")},k(o.approval_result),3)])):H("",!0),o.comment?(u(),h("div",yt,[s[3]||(s[3]=c("span",{class:"comment-label"},"意见: ",-1)),c("span",null,k(o.comment),1)])):H("",!0),o.reason?(u(),h("div",kt,[s[4]||(s[4]=c("span",{class:"reason-label"},"原因: ",-1)),c("span",null,k(o.reason),1)])):H("",!0)]),_:2},1024)]),_:2},1032,["timestamp","type"]))),128))]),_:1})])]),_:1},8,["modelValue"])])}}},Ct=G(gt,[["__scopeId","data-v-125d08ee"]]);export{Ct as F};
